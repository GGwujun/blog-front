<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-front/umi.css" />
    <script>
      window.routerBase = "/blog-front";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>06｜重启：如何进行优雅关闭？ - 大师兄</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/手把手带你写一个web框架/02.实战第1关从零开始/06" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-front/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>算法<ul><li><a href="/blog-front/业务开发算法50讲">业务开发算法50讲</a></li></ul></span><span>前端开发<ul><li><a href="/blog-front/浏览器工作原理与实践">浏览器工作原理与实践</a></li><li><a href="/blog-front/flutter核心技术与实战">flutter核心技术与实战</a></li><li><a href="/blog-front/java-script核心原理解析">java-script核心原理解析</a></li><li><a href="/blog-front/nodejs应用开发实战">nodejs应用开发实战</a></li><li><a href="/blog-front/反爬虫兵法演绎20讲">反爬虫兵法演绎20讲</a></li><li><a href="/blog-front/reactnative新架构实战课">reactnative新架构实战课</a></li><li><a href="/blog-front/重学前端">重学前端</a></li><li><a href="/blog-front/serverless入门课">serverless入门课</a></li><li><a href="/blog-front/type-script入门实战笔记">type-script入门实战笔记</a></li><li><a href="/blog-front/图解googlev8">图解googlev8</a></li><li><a href="/blog-front/vue3源码分析">vue3源码分析</a></li><li><a href="/blog-front/玩转Vue3全家桶">玩转Vue3全家桶</a></li><li><a href="/blog-front/webassembly入门">webassembly入门</a></li><li><a aria-current="page" class="active" href="/blog-front/手把手带你写一个Web框架">手把手带你写一个Web框架</a></li><li><a href="/blog-front/web漏洞挖掘实战">web漏洞挖掘实战</a></li><li><a href="/blog-front/跟月影学可视化">跟月影学可视化</a></li><li><a href="/blog-front/搞定音频技术">搞定音频技术</a></li><li><a href="/blog-front/攻克视频技术">攻克视频技术</a></li></ul></span><span>前端工程化<ul><li><a href="/blog-front/logger">logger</a></li><li><a href="/blog-front/webpack">webpack</a></li><li><a href="/blog-front/webpackchain">webpackchain</a></li></ul></span><span>前端性能优化<ul><li><a href="/blog-front/react性能调优">react性能调优</a></li></ul></span><span>移动端开发<ul><li><a href="/blog-front/android开发高手课">android开发高手课</a></li><li><a href="/blog-front/ios开发高手课">ios开发高手课</a></li></ul></span><span>产品与用户体验<ul><li><a href="/blog-front/视觉笔记入门课">视觉笔记入门课</a></li></ul></span><span>杂谈<ul><li><a href="/blog-front/git实战手册">git实战手册</a></li><li><a href="/blog-front/nodejs">nodejs</a></li><li><a href="/blog-front/reactjs">reactjs</a></li><li><a href="/blog-front/ui设计">ui设计</a></li><li><a href="/blog-front/webpack4系列教程">webpack4系列教程</a></li><li><a href="/blog-front/前端知识体系">前端知识体系</a></li><li><a href="/blog-front/剑指offer刷题笔记">剑指offer刷题笔记</a></li><li><a href="/blog-front/思考与成长">思考与成长</a></li><li><a href="/blog-front/设计模式手册">设计模式手册</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-front/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>算法<ul><li><a href="/blog-front/业务开发算法50讲">业务开发算法50讲</a></li></ul></li><li>前端开发<ul><li><a href="/blog-front/浏览器工作原理与实践">浏览器工作原理与实践</a></li><li><a href="/blog-front/flutter核心技术与实战">flutter核心技术与实战</a></li><li><a href="/blog-front/java-script核心原理解析">java-script核心原理解析</a></li><li><a href="/blog-front/nodejs应用开发实战">nodejs应用开发实战</a></li><li><a href="/blog-front/反爬虫兵法演绎20讲">反爬虫兵法演绎20讲</a></li><li><a href="/blog-front/reactnative新架构实战课">reactnative新架构实战课</a></li><li><a href="/blog-front/重学前端">重学前端</a></li><li><a href="/blog-front/serverless入门课">serverless入门课</a></li><li><a href="/blog-front/type-script入门实战笔记">type-script入门实战笔记</a></li><li><a href="/blog-front/图解googlev8">图解googlev8</a></li><li><a href="/blog-front/vue3源码分析">vue3源码分析</a></li><li><a href="/blog-front/玩转Vue3全家桶">玩转Vue3全家桶</a></li><li><a href="/blog-front/webassembly入门">webassembly入门</a></li><li><a aria-current="page" class="active" href="/blog-front/手把手带你写一个Web框架">手把手带你写一个Web框架</a></li><li><a href="/blog-front/web漏洞挖掘实战">web漏洞挖掘实战</a></li><li><a href="/blog-front/跟月影学可视化">跟月影学可视化</a></li><li><a href="/blog-front/搞定音频技术">搞定音频技术</a></li><li><a href="/blog-front/攻克视频技术">攻克视频技术</a></li></ul></li><li>前端工程化<ul><li><a href="/blog-front/logger">logger</a></li><li><a href="/blog-front/webpack">webpack</a></li><li><a href="/blog-front/webpackchain">webpackchain</a></li></ul></li><li>前端性能优化<ul><li><a href="/blog-front/react性能调优">react性能调优</a></li></ul></li><li>移动端开发<ul><li><a href="/blog-front/android开发高手课">android开发高手课</a></li><li><a href="/blog-front/ios开发高手课">ios开发高手课</a></li></ul></li><li>产品与用户体验<ul><li><a href="/blog-front/视觉笔记入门课">视觉笔记入门课</a></li></ul></li><li>杂谈<ul><li><a href="/blog-front/git实战手册">git实战手册</a></li><li><a href="/blog-front/nodejs">nodejs</a></li><li><a href="/blog-front/reactjs">reactjs</a></li><li><a href="/blog-front/ui设计">ui设计</a></li><li><a href="/blog-front/webpack4系列教程">webpack4系列教程</a></li><li><a href="/blog-front/前端知识体系">前端知识体系</a></li><li><a href="/blog-front/剑指offer刷题笔记">剑指offer刷题笔记</a></li><li><a href="/blog-front/思考与成长">思考与成长</a></li><li><a href="/blog-front/设计模式手册">设计模式手册</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-front/">大师兄 - 前端架构师</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="如何优雅关闭" data-depth="2"><a href="/blog-front/手把手带你写一个web框架/02.实战第1关从零开始/06#如何优雅关闭"><span>如何优雅关闭</span></a></li><li title="如何控制关闭进程的操作" data-depth="3"><a href="/blog-front/手把手带你写一个web框架/02.实战第1关从零开始/06#如何控制关闭进程的操作"><span>如何控制关闭进程的操作</span></a></li><li title="os/signal 库" data-depth="3"><a href="/blog-front/手把手带你写一个web框架/02.实战第1关从零开始/06#ossignal-库"><span>os/signal 库</span></a></li><li title="如何等待所有逻辑都处理结束" data-depth="2"><a href="/blog-front/手把手带你写一个web框架/02.实战第1关从零开始/06#如何等待所有逻辑都处理结束"><span>如何等待所有逻辑都处理结束</span></a></li><li title="server.Shutdown源码" data-depth="3"><a href="/blog-front/手把手带你写一个web框架/02.实战第1关从零开始/06#servershutdown源码"><span>server.Shutdown源码</span></a></li><li title="for循环" data-depth="3"><a href="/blog-front/手把手带你写一个web框架/02.实战第1关从零开始/06#for循环"><span>for循环</span></a></li><li title="验证" data-depth="2"><a href="/blog-front/手把手带你写一个web框架/02.实战第1关从零开始/06#验证"><span>验证</span></a></li><li title="小结" data-depth="2"><a href="/blog-front/手把手带你写一个web框架/02.实战第1关从零开始/06#小结"><span>小结</span></a></li><li title="思考题" data-depth="3"><a href="/blog-front/手把手带你写一个web框架/02.实战第1关从零开始/06#思考题"><span>思考题</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="06重启如何进行优雅关闭"><a aria-hidden="true" tabindex="-1" href="/blog-front/手把手带你写一个web框架/02.实战第1关从零开始/06#06重启如何进行优雅关闭"><span class="icon icon-link"></span></a>06｜重启：如何进行优雅关闭？</h1><p>你好，我是轩脉刃。</p><p>通过前面几节课的学习，我们已经能启动一个按照路由规则接收请求、进入控制器计算逻辑的服务器了。</p><p>但是，在实际业务开发过程中，功能和需求一定是不断迭代的，在迭代过程中，势必需要重启服务，这里的重启就是指一个关闭、启动进程的完成过程。</p><p>目前所有服务基本都无单点问题，都是集群化部署。对一个服务的关闭、启动进程来说，启动的流程基本上问题不大，可以由集群的统一管理器，比如Kubernetes，来进行服务的启动，启动之后慢慢将流量引入到新启动的节点，整个服务是无损的。</p><p>但是在关闭服务的过程中，要考虑的情况就比较复杂了，比如说有服务已经在连接请求中怎么办？如果关闭服务的操作超时了怎么办？所以这节课我们就来研究下如何优雅关闭一个服务。</p><h2 id="如何优雅关闭"><a aria-hidden="true" tabindex="-1" href="/blog-front/手把手带你写一个web框架/02.实战第1关从零开始/06#如何优雅关闭"><span class="icon icon-link"></span></a>如何优雅关闭</h2><p>什么叫优雅关闭？你可以对比着想，不优雅的关闭比较简单，就是什么都不管，强制关闭进程，这明显会导致有些连接被迫中断。</p><p>或许你并没有意识到这个问题的严重性，不妨试想下，当一个用户在购买产品的时候，由于不优雅关闭，请求进程中断，导致用户的钱包已经扣费了，但是商品还未进入用户的已购清单中。这就会给用户带来实质性的损失。</p><p>所以，优雅关闭服务，其实说的就是，关闭进程的时候，不能暴力关闭进程，而是要等进程中的所有请求都逻辑处理结束后，才关闭进程。按照这个思路，需要研究两个问题“<strong>如何控制关闭进程的操作</strong>” 和 “<strong>如何等待所有逻辑都处理结束</strong>”。</p><p>当我们了解了如何控制进程关闭操作，就可以延迟关闭进程行为，设置为等连接的逻辑都处理结束后，再关闭进程。</p><h3 id="如何控制关闭进程的操作"><a aria-hidden="true" tabindex="-1" href="/blog-front/手把手带你写一个web框架/02.实战第1关从零开始/06#如何控制关闭进程的操作"><span class="icon icon-link"></span></a>如何控制关闭进程的操作</h3><p>那么第一个问题，如何控制关闭进程的操作怎么解决？你可以先想想平时关闭一个进程的方法有哪些，如果这些方法都有办法控制关闭操作，那么是不是就达到目的了。</p><ul><li>Ctrl+C</li></ul><p>在终端，在非后台模式下启动一个进程的时候，要想关闭，我们在控制台会使用 Ctrl+C 来关闭进程。不管在 Unix 类的系统，还是在 Windows 系统中，Ctrl+C 都是向进程发送信号 SIGINT，这个信号代表的是中断，常用在通过键盘通知前台进程关闭程序的情景中。这个信号是可以被阻塞和处理的。</p><ul><li>Ctrl+\</li></ul><p>这个键盘操作是向进程发送信号 SIGQUIT，这个信号其实和 SIGINT 差不多，也是可以被阻塞和处理的，它们都是为了通知进程结束，唯一不同的是，进程处理 QUIT 退出的时候，默认行为会产生 core 文件。</p><ul><li>Kill 命令</li></ul><p>当使用后台模式挂起一个进程的时候，操作系统会给这个进程分配一个进程号 pid， 我们可以通过 kill pid 或者 kill -9 pid 来杀死某个进程。</p><p>kill pid 会向进程发送 SIGTERM 信号，而 kill -9 会向进程发送 SIGKILL 信号。这两个信号都用于立刻结束进程，但是 SIGTERM 是可以被阻塞和处理的，而 SIGKILL 信号是不能被阻塞和处理的。</p><p>用表格总结一下终止进程的这几个信号和对应的操作：<img src="/blog-front/static/httpsstatic001geekbangorgresourceimageffebff73733e54b5f94a3cbe6af2b3cc94eb.09bf00de.jpg" alt=""/></p><p>除了 SIGKILL 信号无法被捕获之外，其他的信号都能捕获，所以，只要在程序中捕获住这些信号，就能实现控制关闭进程操作了。那么接下来要解决的问题就是，在 Golang 中如何捕获信号呢？</p><p>对于这个问题，标准库提供了 os/signal 这个库，还记得第一节课说的快速了解一个库的方法么，<strong>库函数 &gt; 结构定义 &gt; 结构函数。</strong></p><h3 id="ossignal-库"><a aria-hidden="true" tabindex="-1" href="/blog-front/手把手带你写一个web框架/02.实战第1关从零开始/06#ossignal-库"><span class="icon icon-link"></span></a>os/signal 库</h3><p>所以，第一步我们使用 <code>go doc os/signal|grep &quot;^func&quot;</code> 来了解下这个库的函数，看看提供了哪些功能。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// 忽略某个信号</span></div><div class="token-line"><span class="token plain">    func Ignore(sig ...os.Signal){}</span></div><div class="token-line"><span class="token plain">    // 判断某个信号是否被忽略了</span></div><div class="token-line"><span class="token plain">    func Ignored(sig os.Signal) bool{}</span></div><div class="token-line"><span class="token plain">    // 关注某个/某些/全部 信号</span></div><div class="token-line"><span class="token plain">    func Notify(c chan&lt;- os.Signal, sig ...os.Signal){}</span></div><div class="token-line"><span class="token plain">    // 取消使用 notify 对信号产生的效果</span></div><div class="token-line"><span class="token plain">    func Reset(sig ...os.Signal){}</span></div><div class="token-line"><span class="token plain">    // 停止所有向 channel 发送的效果</span></div><div class="token-line"><span class="token plain">    func Stop(c chan&lt;- os.Signal){}</span></div></pre></div><p>这个库提供了订阅信号的方法 Notify 和忽略信号的方法 Ignore ，为了全局管理方便，也提供了停止所有订阅的 Stop 函数。另外还有，停止某些订阅的 Reset 函数，当我们已经订阅了某些信号之后，想重新将其中的某些信号不进行订阅，那么可以使用Reset方法。</p><p>然后就是第二、第三步，通过 <code>go doc os/signal|grep &quot;^type&quot;</code> 了解到，这个库比较简单，没有任何结构定义和结构函数，因为管理信号只需要几个库函数即可，不需要进行更多的模块划分和数据结构抽象。在Golang的官方类库中，有不少都是这样只提供库函数，而没有自定义的模块数据结构的。</p><p>理解完了捕获信号的 os/signal 库，我们就明白了，要控制这些信号量可以使用 Notify 方法，所以在业务main.go里补充：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">func main() {</span></div><div class="token-line"><span class="token plain">    	...</span></div><div class="token-line"><span class="token plain">    	// 这个 Goroutine 是启动服务的 Goroutine</span></div><div class="token-line"><span class="token plain">    	go func() {</span></div><div class="token-line"><span class="token plain">    		server.ListenAndServe()</span></div><div class="token-line"><span class="token plain">    	}()</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    	// 当前的 Goroutine 等待信号量</span></div><div class="token-line"><span class="token plain">    	quit := make(chan os.Signal)</span></div><div class="token-line"><span class="token plain">    	// 监控信号：SIGINT, SIGTERM, SIGQUIT</span></div><div class="token-line"><span class="token plain">    	signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM, syscall.SIGQUIT)</span></div><div class="token-line"><span class="token plain">    	// 这里会阻塞当前 Goroutine 等待信号</span></div><div class="token-line"><span class="token plain">    	&lt;-quit</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    	...</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>注意下这里有两个 Goroutine，一个 Goroutine 是提供启动服务的，另外一个 Goroutine 用于监听信号并且结束进程。那么哪个Goroutine用于监听信号呢？</p><p>答案是main 函数所在的当前 Goroutine。因为使用Ctrl或者kill命令，它们发送的信号是进入main函数的，即只有main函数所在的Goroutine会接收到，<strong>所以必须在main函数所在的Goroutine监听信号</strong>。</p><p>在监听信号的 Goroutine 中，我们先创建了一个等待信号量的 channel，然后通过 Notify 方法，订阅 SIGINT、SIGTERM、SIGQUIT 三个可以捕获处理的信号量，并且将信号量导入到 channel 中。</p><p>最后，使用 channel 的导出操作，来阻塞当前 Goroutine，让当前 Goroutine 只有捕获到结束进程的信号之后，才进行后续的关闭操作。这样就实现了第一个问题进程关闭的可控。</p><h2 id="如何等待所有逻辑都处理结束"><a aria-hidden="true" tabindex="-1" href="/blog-front/手把手带你写一个web框架/02.实战第1关从零开始/06#如何等待所有逻辑都处理结束"><span class="icon icon-link"></span></a>如何等待所有逻辑都处理结束</h2><p>然后就是第二个问题“如何等待所有逻辑都处理结束”。</p><p>在 Golang 1.8 版本之前，net/http 是没有提供方法的，所以当时开源社区涌现了不少第三方解决方案： <a target="_blank" rel="noopener noreferrer" href="https://github.com/braintree/manners">manners<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 、 <a target="_blank" rel="noopener noreferrer" href="https://github.com/tylerstillwater/graceful">graceful<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 、 <a target="_blank" rel="noopener noreferrer" href="https://github.com/facebookarchive/grace">grace<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 。</p><p>它们的思路都差不多：自定义一个Server数据结构，其中包含net/http的Server数据结构，以及和net/http中Server一样的启动服务函数，在这个函数中，除了调用启动服务，还设计了一个监听事件的函数。监听事件结束后，通过channel等机制来等待主流程结束。</p><p>而在1.8版本之后，net/http引入了server.Shutdown来进行优雅重启。</p><p>**server.Shutdown方法是个阻塞方法，**<strong>一旦执行之后，它会阻塞当前 Goroutine，并且在所有连接请求都结束之后，才继续往后执行</strong>。实现非常容易，思路也和之前的第三方解法差不多，所以就重点理解这个方法。</p><h3 id="servershutdown源码"><a aria-hidden="true" tabindex="-1" href="/blog-front/手把手带你写一个web框架/02.实战第1关从零开始/06#servershutdown源码"><span class="icon icon-link"></span></a>server.Shutdown源码</h3><p>来看server.Shutdown的源码，同样你可以通过IDE跳转工具直接跳转到Shutdown源码进行阅读，使用第一节课教的思维导图的方式，列出Shutdown函数的代码逻辑流程图。我们还是从前往后讲。<br/><img src="/blog-front/static/httpsstatic001geekbangorgresourceimage5a835ab0b74f880bed2273490c71b4d44783.90d83d63.png" alt=""/></p><p>第一层，在运行Shutdown方法的时候，先做一个标记，将server中的isShutdown标记为true。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">srv.inShutdown.setTrue()</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    func (b *atomicBool) setTrue()    { atomic.StoreInt32((*int32)(b), 1)</span></div></pre></div><p>这里标准库实现的就很细节了。inShutdown是一个标记，它用来标记服务器是否正在关闭，<strong>标记的时候，还使用了 atomic 操作来保证标记的原子性</strong>。这里要琢磨一下，为什么要使用atomic操作呢？</p><p>在Golang中，所有的赋值操作都不能保证是原子的，比如int类型的a=a+1，或者bool类型的a=true，这些赋值操作，在底层并不一定是由一个独立的CPU指令完成的。所以在并发场景下，我们并不能保证并发赋值的操作是安全的。</p><p>比如有两个操作同时对a变量进行读写，写a变量的线程如果不是原子的，那么读a变量的线程就有可能读到写了一半的a变量。</p><p>所以为保证原子性，Golang提供了一个atomic包，当对一个字段赋值的时候，<strong>如果你无法保证其是否原子操作，你可以使用atomic包来对这个字段进行赋值</strong>。atomic包，在底层一定会保证，这个操作是在一个单独的CPU指令内完成的。</p><p>因为这里的srv.inShutdown是一个非常重要的标记位。一旦由于任何原因，它读取错误，会发生严重问题，比如进程已经在处理结束的时候，启动server的进程还继续监听请求，这个时候会导致新接收的请求有服务错误。所以，这里为了保险起见，使用了一个标准库atomic来保证其原子性操作。</p><p>然后是逻辑代码：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">for _, f := range srv.onShutdown {</span></div><div class="token-line"><span class="token plain">      go f()</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>onShutdown在server结构中按需求设置。这个字段保存的是回调方法，即用户希望server在关闭时进行的回调操作。比如用户可以设置在服务结束的时候，打印一个日志或者调用一个通知机制。如果用户设置了回调，则执行这些回调条件，如果没有设置，可以忽略。</p><h3 id="for循环"><a aria-hidden="true" tabindex="-1" href="/blog-front/手把手带你写一个web框架/02.实战第1关从零开始/06#for循环"><span class="icon icon-link"></span></a>for循环</h3><p>接下来进入这一层最重要的for循环。这个for循环是一个无限循环，它使用ticker来控制每次循环的节奏，通过return来控制循环的终止条件。这个写法很值得我们学习。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">ticker := time.NewTicker(shutdownPollInterval) // 设置轮询时间</span></div><div class="token-line"><span class="token plain">    	defer ticker.Stop()</span></div><div class="token-line"><span class="token plain">    	for {</span></div><div class="token-line"><span class="token plain">            // 真正的操作</span></div><div class="token-line"><span class="token plain">    		if srv.closeIdleConns() &amp;&amp; srv.numListeners() == 0 {</span></div><div class="token-line"><span class="token plain">    			return lnerr</span></div><div class="token-line"><span class="token plain">    		}</span></div><div class="token-line"><span class="token plain">    		select {</span></div><div class="token-line"><span class="token plain">    		case &lt;-ctx.Done(): // 如果ctx有设置超时，有可能触发超时结束</span></div><div class="token-line"><span class="token plain">    			return ctx.Err()</span></div><div class="token-line"><span class="token plain">    		case &lt;-ticker.C:  // 如果没有结束，最长等待时间，进行轮询</span></div><div class="token-line"><span class="token plain">    		}</span></div><div class="token-line"><span class="token plain">    	}</span></div></pre></div><p>我们在工作中经常会遇到类似的需求：每隔多少时间，执行一次操作，应该有不少同学会使用time.Sleep来做间隔时长，而这里演示了如何使用time.Ticker来进行轮询设置。这两种方式其实都能完成“每隔多少时间做一次操作”，但是又有一些不同。</p><p>time.Sleep是用阻塞当前Goroutine的方式来实现的，它需要调度先唤醒当前Goroutine，才能唤醒后续的逻辑。<strong>而Ticker创建了一个底层数据结构定时器runtimeTimer，并且监听runtimeTimer计时结束后产生的信号</strong>。</p><p>这个runtimeTimer是Golang定义的定时器，做了一些比较复杂的优化。比如在有海量定时器的场景下，runtimeTimer会为每个核，创建一个runtimeTimer，进行统一调度，所以它的CPU消耗会远低于time.Sleep。所以说，使用ticker是Golang中最优的定时写法。<br/><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABa4AAAC2CAAAAAAUtUWGAAAAIGNIUk0AAHomAACAhAAA+gAAAIDoAAB1MAAA6mAAADqYAAAXcJy6UTwAAAACYktHRAD/h4/MvwAAAAd0SU1FB+cJFwYsADr3m9EAAAABb3JOVAHPoneaAAAkEUlEQVR42u2d+UMTx///P3/YK4nhEMQWj15aSvAoLd5vrVb8Ft8Kb7xaK4pWa6v1RlFbrPq2tWpBsfUoCAXvd6koFOSqeCJgMt+Z2SOzAcLKtUl9Pn5INjOzs7Ozu49MZic7/8fC0pBdzl4Vsr9wugQAANA3/xc+GroGAIDIALo2ga4BAJEMdG0CXQMAIhno2gS6BgBEMtC1CXQNAIhkoGsT6BoAEMlA1ybQNQAgkoGuTaBrAEAkA12bQNcAgEgGujaBrgEAkQx0bQJdAwAiGejaBLoG4FUlUHSSsR+POl2MfoCuTaBrAF5ViukrxtZShOuuH13fz7403CV4cvXM6etPxVLz8at2Vig97h+WgkDXAPwTCNSXnKvpkos1x+/ZW8UX08ZYnXuW02UPTz+67sgZ5p8HnevjiRP35XPxBZfXe6KHlu+MidQ9LEWBrgGIfjo/TRBKST4khP0NHbe1UjF9Kt6yIrx53Y+u2e5VT4d1+9mU/MmewtxRlN23rh/Efqh+hK4BAH3QMJXGZu3es9RDWX77uva5ZSv8Gs12uvxh6U/XtdmFw7n5nyntiXj/I54u9KnrFoKuAQA2CKRRRqtYqHuDdtvW9R2aqS2kUJvTexCO/nTNfsze/yRcfFt1WYPel+y/U/nYDK8rf2xJZ4nsLK8JyIWttEML+Ybypa79168/C91EUNePKtqCum4prw/0Varm8vt9xvUFdA1A5NBxtTpEnaFO6S3dT5Si9Vqz2/R2UNddt6oNr/RmrMO0TQtZS6ed3u9w9Ktr/w/Zq/eXlJs0WGIfLHYRUcoVsbw3ji/6/uBLPlf1dKJZrvkyzSLX92pksWvjlgSiZhn3Pc3R3Nuw+YTQ9UEe490nsvDIL4nDrt2/ufgmXC7eyG/O4HlMa9B0fXEC/5D4HWNHXB+LlJmuY+LQxbnafJ4bPh6Xfjd0V25sD0v2eqcPBgCvFM/uVZpiabVGtS9y84t4gXkRa06ZGXqx90g3lU4Zi2sXtem6fpozijtkThPry1j/Nvqsz9A6pyslHP3qmrE/9+ZmBylRo/yzKe3rHXMpoZGxNZS87eBKd1w1Y6k0ftTMuRu9bnEI2j2j/lYji2ksTVg0RftCbEqkjFL925DHjHGvPbyM6BeRRbsIOky763I+obE5ORdZyziaWVDgmxwrdH3U5V55IC+BV26rO6aDf3vG0//j6Uvpfb5q7Hvbl8XQ1NABJN9mh2eN0wcDgFeIB4fUq6/SEtf+JqXv2ZRCb7XrAZpTNoRe7KHp/F6v5bKXuu5IodTtu2ZR0r2+jDWDmrT0tyjT6WoJhw1dM/aircHkkRpRR/GimhbTPlZFCX/zxbOirz6V4ir48lIS/d7f0RJLZDFRVpeZw+03ieKzfpJNaR5zkolaXKTq2uwMWUu5/Eh08CZ2N2tPdF/gQXeSXdfZHCplrIxodLdYt4CvOo3n3+qh30N2o/lcWLIPOH0wAHh1+N+q3G8v3zXFYu0DzacsfjkHppBx60x3SujFHpqukSZb8pG6/or+xSUfWM/F0oexJlOnlr6ZMpyul3DY0nWfPHF7Tge4Gs/X8p8T2q+IDKrlVbtDLP7Kv/1EQKklspiS1B4o/6XVrxHFrWgUuvaJkAuixnvqmn9vyhZ5pdD1ATGShFNIOayIVjG2ifLoCgsku+7zVc+LqNl04uV2JvuYkwcCgFeKllXr/+ozMhDnaRTvl3wb9RDdKSEXe4901SFDO6SuE9yyr6Qzmer7MNY4j57+ieagSGVwuua1QRM+K+VfXcxHqwsFGXSOV22NiPSPo3usgV5/YYkspqyQTPyV+WNpwj0ekys+drle603XDXpF+r1c12v0OwL1NJ09cCcHWMqketrMrovvxlRqEVE7+XfvSwFdAzBi7FzR1HdkE6WEhOhOCbnYe6RrDAkQum42wnLolz6M9R7p45UbKKL/KDNIXbMrK3jbOH6LnyWSQSGvWm0wyWbaxnbTJmaJLKb84Op1+n+Onn1Mc82BfO5edV3NU0je5LpeQBVyuYNeZ2w+XW3kmU728V89h8xVD0DXAEQqddnhhmBU05yQEMMp1ou9Rzr/qFhzSNjtM61S12aizVTUh7Fmk97Sv9ajMRlRDFbXvIJubk/k9eej6jaNLl612ndVLU3i31s1zBJZTBuDK0+iOm3hyShvp1XXD8TinqCuG42fKeJW42qzdT2NsWO0tYjKWD41pYmbm9A1AJHO2eyWMLENlCrf/Q1/6yGGU6wXe2/pzMEQPq6ekNa17CbtxVgrRZe4lv1mp2smHIPT9ZUsOarxOk1gWXpX8brMJrNq2Qd0hNIZs0RadL2K9moLL+LoqarrWfQ/UbHvqH3Xo9q0jXFd76ccmVT0XbNHo3yLR3exy7RVdlxB1wBEOsezw/0xwrhR9QN9rIcYTrFe7D3TnSCf/i+6szRF6wwJjDb7ruv6MNYPtEFbKYd+dbpmwjE4XV+jMaIST/NW9AVtLM1/RZeFqesj/JdGEWOWSEPXDblHGPuFvHLAY8dammrpDFkpv+VOktD1I5495zNa4Wfs+Vx9ZMhFHlSb7LrG3xYRfcJYV5y2MegagEjnWHbY6NXyYvenEr8oi3IbFadYL/Ye6fwp9KH8T0dpnLvUHBkyX4wM2UAL+zJWs9FKH+8Z3oduDJLB6do/g3wbC3OSRP/0JzR+295ZbvcfStU+jqEYOQxEiTR0vZ7cD8WAHZqVl/e+h2IrLLquJlp2cK1njNA1m0Jz/9PMmpNp9v69U2PFrUZ2zO1edXhDIn0uVviR5GD4xeR+wKBrACKffnTdPJZmFeRNoPQu1u4Wd7tMp1gv9h7pWMN0ip+bv+59kmP7tHHX75Hvm32zKam2L2OxBSTHfZ+j8MVymkH2Xbdmia762M+5QF9sj+GL74qH56W5OvT45bRMviuRZ/XeodLYWfznkP+7t0QO7mX/EzF5Mkbomn3Lvz5jNhwi8RfHS1OIavmhmeEiGn9xhlsMhL80UfyrsUiu8MTrEj+Jiuhf4lOaputD0DUAkUo/umbNc8SfmZfx6zowI+684hTrxd4jHW9450ulZEj/7pJuf5Yr/tU4VwxF6d1Y7KrWm5LhrnW6YsIy6FuNj6ov1+gj3F/8Wd7UZ4dUz8jn2lug9WrZ3Y6eK3TcquoKDXtcURf80FJW/9LPBQkHdA3ASNGfrhl7WnX1obb0/GXTPa68HvKgo66bVcb/cHo31gLXHcaqIrxxPQQjQ/4xQNcAjBT963pkuUorGcuM8MY1dB0EugZgpIg0XbMbtxmrue10KfoBujaBrgEYKSJO11EBdG0CXQMwUkDXAwG6NoGuARgpoOuBAF2bQNcAjBTQ9UCArk2gawBGCuh6IEDXJtA1ACMFdD0QoGsT6BqAkQK6HgjQtQl0DcBIAV0PBOja5J+g65rj9+wk62jrDn4oPe7vfb2nv5+sbHN6j1hXW9uQPmtguHkRNjZQX3KupstmVsNRrsFUp3ra3D9+0/bp1hvQ9UCArk3+CbqWDyCzk+y74IeJ1N3behUpLvEwnMwaR3fo8UduojJHi2CbSvHA/WMxS/tO0flpgqjT5EMjLuyOtDFVLFx1Vrb0H6SeNsdpq+3TrTeg64EAXZu8Uro+HPzQu64LPPRB3sHN71DsVSd36CiNW/V5hD/IQWcTiWe75VBcn+3rhqk0Nmv3nqUeyvKPcOHqifawMNWpFb6fIPW0ga6dALo2ga4VSsh7VLz7v6bXntjJcphYqE/KGQWskXq7+2lJXwkCaZTRKhbq3pCPcR9RDm94wMJU55qeul4DXUcc0LVJxOq6rbqswWiNdZbX9Nb12FhWK39fG9dP163qZz3X9t+plJNFmNfdo4o2q64fVdTKtP4U+lFfP1NfUrJkrLn8vlGM7qu39Mffdt25fGOo1T6F9N5zy+attdBxtbr/Lva6crnr9RXV7UZQsOTsYcV9M6VZS70eABaai1H1vRnPmt9PlKJ3gtymt7WFlvLgQ4CV4qj1OzzVqVeqecTMwgd3zQwyTgrjtPH/ec1v1bWZwj7Q9UCArk0c1XXgYYOJVXkPFos+5JQrjBW7Nm5JIBrnEr2Q7IZrvJHk1FieYqyYjUG7fp7miKexz2myrM3Y3ji+6PuDGdddcwb/PK0hqOv6dB4Qt5lfeaWUYlx/lYsKrVn6PDd8PF36XVGiL77mmXrF72x2YhwPHbU2tFu2u+FlaFZX/dolHj3vcjerm9drwUzYvsjNt7uAl8Z/4T7rFZ+rejrRGsbKU0TX8YLGkJI3fshD3/r9QzExs1JLPQ6ATjAXpepnikSuRHbJtZodc82XCRe5vlfzm0qnjCzWLhLavDhBTLHxHbMWR6lfKy9VkQ2t1pUzXE3B6tQxj5hReGXXzKDgSaGfNofieaF3KLpWUli4WxWGL6DrAQBdmzio65ZvV2UHsUzu6Z9NaV/vmEsJjayYxtKERVM+p7UiIt+YDZQVUEze/sw4OmDMdZRCqdt3zaKke+ravLWUvO3gSndctX7dtYyjmQUFvsmxhq7/TKQlhTsnU6aYhGOXpYBKliyVYt/bviyGpvp5idzuT7fwS/wsY5fc3v8Urk6m9SH71pr9MmxRVy3OyYmlrJycB+rm9VowWontb1L6nk0pYt69PTSm9wfZp9L4UTPnfsUak1yLC9ZPpDRryZuSaOaBgvcTk8haSz0OgIaSi1L1O3Im0bycNexXWsUeeqX42z2j/lby83u9VqMddblXHshLoHXMUhylfq3kvlRNWg8gS6cmszr1oOARMwqv7JoRpJwU2mmzjeLyi9a6p5i6VlNYWB++gCN/mUU/0LWJc7ouy83ddaqs3MDSRqyjePHjdDHt49c0ZfG26x0a280tkizniue0xnnF/MIllOQ3ZhL9l5hJdD0tUteuooS/mZhhbbZ+3a2lXC6EjgwydD2fvuQJutLpClsZbAhKlCy5TqbxUrR66HdRop957Dqax6tPXL+8zZ/Qbd255+Uvw/WQqtF+vaub12vBIJ+y+AYDU6iQ7aCEDvZ7gYnZX5FKcRXifZ78hutM4DtoLXkOr4iuTOK6VmupxwHQUHJRq17vPBC6ZkvlPIHf0RI1v0aabNm19kT3Bf52J9l13VIcpX6tXHmpmrxlXZnrmoV0hqhHTCu8smtGkHJSyNPmvjfuttwhU9dqCgu/FoXhP9D1AICuTRzTdVX2l019Rj5xe04H+NV7vpZf00myEzSdePv7Mk3TU+yl1fJ9ia9Ou34S3PJ3dGcy1Str/1u04jgZVCuvO97Yk5dupaHrWvLIH9CXaRm/BK3XnpIl14mcEm82neAlkoW4Qm8xtpnmifyu/DKkgx40v6ibN2pBIxDnka3eS76NrKukVhjP5I6RKJV2aBVd0inecumIWvJuj1YRDW6ua7WWehwAFpqLWvWqrn+l92UepWp+1cGvAMkBfaapQsqxVKRSv0NIL7pWj5hWeGXX9CD1pJCnzS7959NcQ9eWFPZB3/VAgK5NnNL149VfdIaJ/oZowmel4iZUMWXJkCJaztgK8y79KjqtJD7OmilF+5BDvyhr+2h1oSCDzsnrroF8MpXfq+u6hJJlgp00hed+Wi2DJctUkuNxd1IBL9EasfjCG8dY41vkmbd/qMfcSb9YNm/UgkaTEWXQUmNitsFTyRg8Xn0wf1XuNGvJ71GaFvkG17VaSz0OAAvNRa16Vdf+cXSPV/DrL9T8GkOKukZfuZ6mWypSqd8hpBddq0fMuK9o7poepJ4U8rTJJW3kyy5D15YU9oGuBwJ0beKUrk9lh/9r2JUVrxHFbxH9rfky4JE3ruN5gtf4rT9fGZwlrp9qmqN92ExFytqJZquzUF531TRXS/amruuDZoJEtkOO0pV0n/nNmmWqNtP8ASm9PBk8mluGPd6X4SZKvzGklSP9Ytm8UQsaZlQ4Ukm7e/swncg78e3R1pJfo1laMh/XtVpLPQ4AC81FrXpV17yg29hu2sTU/PyjYs3RHrfPtLIF+sod9LqlIpX6HUJ60bV6xLTCK7umB6knhTxt5pOcYZydMHRtSWEf6HogQNcmTul649b+Uvhvbk/kkiqmjdrnZXTy52AbM5eK5Xt7Q3do6/q8sraPqts0uuR116i3rlms2bperCd4yDflM9RSwrdkybIvXYsinJ5PCX137AyA0Nb1+WAtSBooVauihr+1gAe3TczfLKn0VKaZQ0tFW3KPteTtNFHLYrRsXQdrqccBYKG5qFVv0XUtTWLviTa9ml8qmUOyfTxutdm6nuaQrpUjJguv7prZug6eFPK0WanvxN5g61pJYR/oeiBA1yZO6Tq3KFzslSw5tPU6TQiK6iItzCRz/MgO7VL3T6Kb8voJjDZ7euuUtbP0vtB1mU163/WoNi1O13UNvS0bkFWZ+9iLSca9xq50OmfJsi9dr10qm7ALaUirUfrFsnmrro0e+B/oYy2g975rqeu79IbcwY9CSv6G1hFwQtxqVGupxwFgobmoVW/RNfuAjlA6f1fzO0E+/TbsWdFxsJ9y5Aet7zpYnBHTtXrEZOHVXdOD1JNC77vWSrrQ0LUlhX2g64EAXZs4pevw271GY4RrTvPmmikq/wSiceIaacg9wthf3ljRNXtGNBL1kSHzxTiKDbRQXfuCGOvG2H9FH4gcGfIZreB5PJ9r6DrwAe3nCToni5+7p8grnw/RvoQyui1Z9qXrj+TYP38K/TSUlWOMDAlu3qpr3kYVe+FP5c65l1XI2G/7TJSRIVLXtyhZNJkLKaTkP1LSL12dP8YLXau11OMAsKLcRksuatWzDXSSmbo+wr8uivi7mh+vmw/lmOfSOHepHBlykX+oTXZdc0bX6hGThVd3TQ+ynBTayJB4MSLpojkyxJLCPtD1QICuTSJT1/4Z5NtYmJNEmxRRfUkkByivJzf/BbqV4vML5nnEzTFt3PV75Ptm32xKqlXXZp/Q+G17Z7ndf+i6bk6m2fv3To01bjWy617KOrgmWetmOeChd5dvWRZPk4Q8lCz70vVFV1zW/i0ZlNDMhhDNL+rmQ3TdPJZmFeRNoPQulkeu9l4z0XXdlUzzj34/jyaHlDywkWiUh1Z/IMZdK7XU4wC0uynfkota9ewcvb78sKHrxzEUIwewqPk1TKf4ufnr3tc7xo+53asOb0ikz5kzulaPmCy8Zdf0/VFPCnnabKXRG4+s9SSaA/ksp41toOuBAF2bRKauWWuW+GEf+3k3/wm9WQ+7S9o4s9LYWaKLuUg8522CaNvtkn8ze5Yr/gM4t8myNnuxPYYvvntJJpP/apzhIhp/cYbbr6/3xzSewJ2njZOrzhB/xxu9TZpOzTJN08khfk2f1S0zRvRd/5gsNjXlChtKpmsbUzYfrAWN5jniv3rLuIYuJC7sPZM0lzauo/odnnLKseLQkrPyzQvXlfjT6IGllnocgMCMuPOWXNSqZx1r42gZ1/Wncq3l+rg2S35d+W+JvDL0duilieIGXZHcqWBxlPodQtKpNVidOsoR0wpv2TUtSD0ptNPm8Gj+7Zb1K21jvZ02doGuBwJ0bRKhumbsUfXlmme9R+n/4gvU/XbP8hy4rptVz3qu/eLP8ibLoygeV9RZ82uvCD63gvnvqo/KULLsA/+9S9WNbJgIs/mnVVe1u1z9PmbjRU35o56h5SUy0D86vvdaUqrweY9celR9z41a8ntceV15yEBLWb2TD/PuccR6rSDLSSHWqq3sCJ/CBtD1QICuTSJW12B4+VT7V/8PNNPpkrxCQNcDAbo2ga5fUa6Pcq8+efkrb/Q8q/UfAHQ9EKBrE+j6VeVn+Ry6sSedLserBHQ9EKBrE+j61eXG8R+vPRt8NsA20PVAgK5NoGsARgroeiBA1ybQNQAjBXQ9EKBrE+gagJECuh4I0LUJdA3ASAFdDwTo2gS6BmCkgK4HAnRtAl0DMFJA1wMBujaBrgEYKYZT14Gif+oQeujaBLoGYKQYTl0X01dO794wAV2bhJ8mgNPV1jYcz+OBrsGrx4nsbjvJSo9bZ2r+4XT/6wR8MW39pwol7HO6AvUl52q67GY1fEDXJv1MwvX4IzdR2TBsF7oGrx6/ZtfbSTaRrFbXJ2pTqGwJDSnWn2FrE5lBR9qYqj5TdH4qHpNLyYccFzZ0bdLPFLdHadyqz4d6om8BdA1ePdqyi+wk61fXm+hS6Do+d/i5qnvLoJ6Ck0mH0jCVxmbt3rPUQ1n+l8h4OICuTR6v/qIzTPTC4XpgG3QNXkG+y7ltI1W/ul7TQ9d3Xu5BuHoGhzc86CNBII0yxNQOrO4N2u1UbelA10Gqsr8MM4u3OW9S163q4NOAOstrBtufDV2DV5Cn61dcDpvgUUWbqetHFbVaw9aYtf5OpT55jalrM+iwmOdG0FatTq/Bqa+oNifTaSyr7bJmEIKZ30+UoneC3Ka3tYWW8uCsEt1Xg1MzNJffH97ZJqBrhbLc3F2nyso1rqoxX7vEDFMudzN7miOmoZojvF7s2rglgcjG3ITfF4Uhe7/T+w3AyNP2Rfam7y+WG7RaY5sziGhag9R1fTpfjtss1Kvpeq+Yl873B2Mz+WVJrkQ1iP2bykWaB4tFXEpwLrpy+ZjcBXL2nFNjxRNzC5QMMlxNx1zzZcJFru/V/KbSKSOLtYtEk+3iBDFnm5h5utj1xdc8nVf0o/g8N3w8PP3ucNYZdK3S8u2qbINNakRxTk4sZeXkPOhIodTtu2ZR0j1xS2MsTVg0xcZd6OywfOH0bgPgAF3nNypXgXUe9ZZxNLOgwDc5luv6z0RaUrhzMmUyXddrKHnbwZXuuGq2I2cSzctZowaxGXISYf9sSvt6x1xKMCY3a0xyLS5YP5HSuPULKCZvf2YcHQhmkE5ND71u8Z3R7hn1t5Kf3+u19lgfdblXHshLoHXCAG73p1v418BZMSNy7Hvbl8XQ1OHs34aurQQeNuiENpq1zpCv6F/8p09gPS0SB4uy7N0rvloVhuxvnd5pAJyho8m43BqsjxtfS7lcex28id3N5tOXPKQrna5ouq6ihL+ZmI54NjP6MtSgySRuQdVRvOj4WEz79Bzn0Qb+2pnAc2mN817jyyWU5Dc7Q8RM8UvlDPXf0RI1v0aabClZe6L7An+7k+y6LgzwM19eR/OErqdxGbR66PdhrC/o2i6arhPc8sdOZzLV84OV9HKzP/cO+q4BsMKbtPJHayXXdS15ZEfJZTEvu9D1v0XDlpNBtYZt1aBxHrH0xO05HeD6PG8M5qoqkQMJcukI20urZdASX51F17/S+zKPUjW/avmtEOQAaX/wKaQcboBpYvEKvSV0fV4sz6YTw1gv0LVdpK6bKUX7lEO/8IOVNRQZQ9cAWGkgn3z3e6m7hJILBTtpiqZrH62WARl0zrCtGvQePRWrfkM04bNSdYL26oP5q3KnUQFbRcqfbRRd+8fRPb7p11+o+TUal7yZXlu5nqZzA6wRiy+8cULXcgD4Tp7/8AFd20XquprmaJ82UxE/WPlDkTF0DYCVapqrLbxJ3QfJIFHTdaIZUGjYVg2aTX/JVa+seI0ofovRlfwwncg78e3RXKfz1TG5iq75Vb2N7aZNlvz8o2LN0R63z7SyBfrKHfQ6N0CeXB4tdS1HnRyAriOC0Nb1eX6wNg5FxtA1AFYa9dY1ixWt68VtGg+N1nW1HtAVbF0Hg1ZSqZ6L/+b2RKNJ5Z9DS0W/yB6u01wqlmHtDd1WXdfSJN44r7Hml0olRrF8PG612bqeBl1HLlLXgdFm33UddA3A8OD3jpJ919eJumvobdlCrsrcp+k6S+8eXpfZZNhWDfpB3lO8knVcy2CCluNdekPm8hHX6Q7Nsv5JdNOqa/YBHaH0kPxOkE//q85Z0R2zn3LkB63vWmYEXUcexsiQ+WJkyAZayKBrAIaJz2gFt+vzuVzXgQ9I/DOhczJVarq+QG8JM/5XdphsIPGwVDWomVL54jUaI7qwT/P2MivKbWS3KFmM4iokrtO/vLG8Bc3OyFGBWga6ro8QUVFIfv4U+lAOEyuNc5fKkSEX+YfaZNc16Dpy0XTd8R75vtk3m5JqoWsAhovmZJq9f+/UWC91s+teyjq4Jlne2JeG/YTGb9s7y+0Wf2I5R68vP2wNWiC87p9Bvo2FOUm0ibW7KZ91JdP8o9/Po8lCp1spPr9gnkfcqjQy0HT9OIZi5GgvNb+G6RQ/N3/d+7KvnLFjbveqwxsS6XMGXUcu07XD8SxX/Ktxrji2Z2nzUGQMXQMQSvMMF9H4izPcvJH9xzTe6HXnCY96hK5fbI/hAe/KToyOtXFigJ8adJU+5q+tWeJOYezn3SwwI+48Y9Xv8Ot2yrFiqdMi8Yi9CSeVDNJJjhZcLpZDNsG68t8SeWXo/+S5NFHc9ixiwgB5MmQM13Wa5odD0HVk0XWz6tngcwkCXQPQk8cVdeZye8UtdUgee/FneVPI0zmUoAWuO+LtUfXlGu1KfS4T1JQ/MlMH6n67F/YJ1yGbeFx5/UkwrqWsfnifDdIX0LXjQNcADCVXaaXTRRgmoGvHga4BGFJu2Hk2azQCXTsOdA0AsAN07TjQNQDADtC140DXAAA7QNeOA10DAOwAXTsOdA0AsAN07TjQNQDADtC140DXAAA7QNeOA10DAOwAXTsOdA0AsAN07TjQNQDADtC140DXAAA7QNeOA10DAOwAXTsOdA0AsAN07TjQNQDADtC140DXAAA7QNeOA10DAOwAXTsOdA0AsAN07TjQNQDADtC140DXAAA7QNeOA10DAOwAXTsOdA0AsAN07TjQNQDADtC140DXAAA7QNeOA10DAOwAXTsOdA0AsAN07TjQNQDADtC140DXAAA7QNeOA10DAOwAXTsOdA0AsAN07TjQNQDADtC140DXAAA7QNeOA10DAOwAXTsOdA0AsAN07TjQNQDADtC140DXAAA7QNeOA10DAOwAXTsOdA0AsAN07Ti5RfbSvbB+LD3eZWu1p7+frGxzeh8BAIMHunacjVv7SVDZwl860sZUWUJTqd1G5hUpLuJk1ji9lwCAwQJdO86p7Hth4zfRJf5aT7THEmxL1wUe+iDv4OZ3KPaq07sJABgk0LXjPF79RWe4+DVS1+zwhgeWYDu6LiHvUfHu/5pee+L0fgIABgd07TxV2V82hYnWdW3QWFYrO62tun5UUes3ljvLawJywZ9CP+phmeYSACBKga4jgLLc3F2nysoN7qtxM0XfsyuRsQyXcPqpsfzj2AJm6PqM1/MzY/XpPDRuMxd2sWvjlgSiZrluKaUYDq9cVOj0XgIABgd0HQm0fLsqO8ivatSOnEk0L2cNY+nEdV1AMXn7M+PogK7rI25vCWN/JtKSwp2TKZPrmsbShEVTtKEgu2iX03sGABgyoOvIIPCwwSSkl1nvDBG6bo3zXmOiSzrJL3W9hxKu8M/z6Uv+2pVOV7iuKcsc4LeSTjm9XwCAIQO6jngUXe+l1TJoia9O6HoTJd/mn2rJ0ypCL9Myruukx+aa8+mK04UHAAwZ0HXEo+h6FZ02g1Mpk+iyWCqh5ELBTprCdZ0VXHOFkhwAEO1A1xGPouv5VGEGpxJ5ydfBlw6SQSLXdX5wzR3BodrdZ35zej8AAIMDuo54FF3nUrEMam/o5rrOaMugrIBoXS9u03jIdb0xuGYx+QL6Yona6gYARCPQdcSj6HoH5YlF/yS6yXXdxlqSaSdjNfS2HK9XlbnPqusXk4x7jV3pdM7p/QAADA7oOuLZQCfFm9D1X95Y8fCPMzRRH8hX6XGdZ4EPaD8P7ZxMlaauG3KP8NdT5P1OfGpfQhndTu8HAGBwQNcRzzl6fflhfdz1VorPL5jnEU1l7W8yhZRQy657KevgmmTR32Hoej25H/K3Ax56d/mWZfE0yc7zoAAAkQx0HfF0rI2jZULXYrReUQIRTRDN7TTtT+jLaXIX+2MaD3XnPWbsLG2WK5XGzpLd1tUZcTxq9LanTu8FAGCwQNdRRqDut3svega3V9zqsAQ8Nxb8d8sa/P1mCwCIeKBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICqBrAACICv4/0EoN+JFJ4jgAAAAldEVYdGRhdGU6Y3JlYXRlADIwMjMtMDktMjNUMDY6NDQ6MDArMDA6MDAPhH5/AAAAJXRFWHRkYXRlOm1vZGlmeQAyMDIzLTA5LTIzVDA2OjQ0OjAwKzAwOjAwftnGwwAAACh0RVh0ZGF0ZTp0aW1lc3RhbXAAMjAyMy0wOS0yM1QwNjo0NDowMCswMDowMCnM5xwAAAAASUVORK5CYII=" alt=""/></p><p>再回到源码思维导图中，可以看到真正执行操作的是 closeIdleConns 方法。这个方法的逻辑就是：判断所有连接中的请求是否已经完成操作（是否处于Idle状态），如果完成，关闭连接，如果未完成，则跳过，等待下次循环。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// closeIdleConns 关闭所有的连接并且记录是否服务器的连接已经全部关闭</span></div><div class="token-line"><span class="token plain">    func (s *Server) closeIdleConns() bool {</span></div><div class="token-line"><span class="token plain">    	s.mu.Lock()</span></div><div class="token-line"><span class="token plain">    	defer s.mu.Unlock()</span></div><div class="token-line"><span class="token plain">    	quiescent := true</span></div><div class="token-line"><span class="token plain">    	for c := range s.activeConn {</span></div><div class="token-line"><span class="token plain">    		st, unixSec := c.getState()</span></div><div class="token-line"><span class="token plain">    		// Issue 22682: 这里预留5s以防止在第一次读取连接头部信息的时候超过5s</span></div><div class="token-line"><span class="token plain">    		if st == StateNew &amp;&amp; unixSec &lt; time.Now().Unix()-5 {</span></div><div class="token-line"><span class="token plain">    			st = StateIdle</span></div><div class="token-line"><span class="token plain">    		}</span></div><div class="token-line"><span class="token plain">    		if st != StateIdle || unixSec == 0 {</span></div><div class="token-line"><span class="token plain">    			// unixSec == 0 代表这个连接是非常新的连接，则标记位需要标记false</span></div><div class="token-line"><span class="token plain">    			quiescent = false</span></div><div class="token-line"><span class="token plain">    			continue</span></div><div class="token-line"><span class="token plain">    		}</span></div><div class="token-line"><span class="token plain">    		c.rwc.Close()</span></div><div class="token-line"><span class="token plain">    		delete(s.activeConn, c)</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    	return quiescent</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>这个函数返回的quiescent标记位，是用来标记是否所有的连接都已经关闭。如果有一个连接还未关闭，标记位返回false，否则返回true。</p><p>现在源码就梳理好了，再整理一下。</p><p>为了实现先阻塞，然后等所有连接处理完再结束退出，Shutdown 使用了两层循环。其中：</p><ul><li>第一层循环是定时无限循环，每过ticker的间隔时间，就进入第二层循环；</li><li>第二层循环会遍历连接中的所有请求，如果已经处理完操作处于Idle状态，就关闭连接，直到所有连接都关闭，才返回。</li></ul><p>所以我们可以在业务代码main.go中这么写：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">func main() {</span></div><div class="token-line"><span class="token plain">    	...</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    	// 当前的 Goroutine 等待信号量</span></div><div class="token-line"><span class="token plain">    	quit := make(chan os.Signal)</span></div><div class="token-line"><span class="token plain">    	// 监控信号：SIGINT, SIGTERM, SIGQUIT</span></div><div class="token-line"><span class="token plain">    	signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM, syscall.SIGQUIT)</span></div><div class="token-line"><span class="token plain">    	// 这里会阻塞当前 Goroutine 等待信号</span></div><div class="token-line"><span class="token plain">    	&lt;-quit</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    	// 调用Server.Shutdown graceful结束</span></div><div class="token-line"><span class="token plain">    	if err := server.Shutdown(context.Background()); err != nil {</span></div><div class="token-line"><span class="token plain">    		log.Fatal(&quot;Server Shutdown:&quot;, err)</span></div><div class="token-line"><span class="token plain">    	}</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>在监听到关闭进程的信号之后，直接执行server.Shutdown操作，等待这个程序执行结束，再结束main函数，就可以了。</p><h2 id="验证"><a aria-hidden="true" tabindex="-1" href="/blog-front/手把手带你写一个web框架/02.实战第1关从零开始/06#验证"><span class="icon icon-link"></span></a>验证</h2><p>到这里，我们就完成了优雅关闭的逻辑。最后验证成果，写一个10s才能结束的控制器：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">func UserLoginController(c *framework.Context) error {</span></div><div class="token-line"><span class="token plain">    	foo, _ := c.QueryString(&quot;foo&quot;, &quot;def&quot;)</span></div><div class="token-line"><span class="token plain">    	// 等待10s才结束执行</span></div><div class="token-line"><span class="token plain">    	time.Sleep(10 * time.Second)</span></div><div class="token-line"><span class="token plain">    	// 输出结果</span></div><div class="token-line"><span class="token plain">    	c.SetOkStatus().Json(&quot;ok, UserLoginController: &quot; + foo)</span></div><div class="token-line"><span class="token plain">    	return nil</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>按顺序执行下列操作，就能检验出你的关闭逻辑能不能跑通了。</p><ol><li>在控制台启动Web服务</li><li>在浏览器启动一个请求进入10s才能结束的控制器</li><li>10s内在控制台执行Ctrl+C关闭程序</li><li>观察控制台程序是否不会立刻结束，而是在10s后结束</li><li>浏览器端正常输出</li></ol><p>依次操作后，你在控制台可以看到，在执行完成URI之后，程序才退出。<br/><img src="/blog-front/static/httpsstatic001geekbangorgresourceimage770a777151e8f5604b3fa6cf228ee3956f0a.170bc77f.png" alt=""/></p><p>而且，浏览器中正常输出控制器结果。说明你已经完整完成了优雅关闭逻辑！<br/><img src="data:image/png;base64,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" alt=""/><br/>今天只修改了业务文件夹中的main.go代码，框架目录并没有什么变化。<br/><img src="/blog-front/static/httpsstatic001geekbangorgresourceimagee069e0e66094f173768b93e2d121e1556069.ca7a0326.png" alt=""/></p><p>有的同学可能会很奇怪，重启这个逻辑不应该放在框架目录的某个地方么，难道每次启动一个服务都要写这个逻辑么？不急，先了解掌握好优雅关闭的原理，在后续章节我们会为框架引入命令行工具，这些优雅关闭的逻辑就会作为框架的一部分存放在框架目录中了。</p><h2 id="小结"><a aria-hidden="true" tabindex="-1" href="/blog-front/手把手带你写一个web框架/02.实战第1关从零开始/06#小结"><span class="icon icon-link"></span></a>小结</h2><p>今天完成了优雅关闭进程的逻辑，通过标准库os.Signal来控制关闭进程的操作，并且通过net/http提供的server.Shutdown来实现优雅关闭。所有代码都同样放在GitHub上的 <a target="_blank" rel="noopener noreferrer" href="https://github.com/gohade/coredemo/tree/geekbang/06">geekbang/06<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 分支了。</p><p>讲了很多代码细节，相信你看完shutdown这个函数的实现原理后，会不由得感叹Golang源码的优雅。很多同学会说没有好的Golang项目可以跟着学习，其实Golang源码本身就是一个非常好的学习资料。</p><p>如果你能对其中的每个细节点画出思维导图，顺着导图中的分支展开分析，思考作者为什么会选择这种写法、有没有其他写法，多多练习，你一定会受益颇丰。</p><h3 id="思考题"><a aria-hidden="true" tabindex="-1" href="/blog-front/手把手带你写一个web框架/02.实战第1关从零开始/06#思考题"><span class="icon icon-link"></span></a>思考题</h3><p>在如何控制关闭进程操作中，阻塞的最长时间实际上也是可以进行控制的，请尝试一下修改代码，控制优雅关闭的最长等待时间为5s？</p><p>欢迎在留言区分享你的思考。感谢你的收听，如果你觉得今天的内容有所帮助，也欢迎分享给你身边的朋友，邀请他一起学习。我们下节课见～</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/手把手带你写一个Web框架/02.实战第1关从零开始/06.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/23 20:47:50</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-front/umi.js"></script>
  </body>
</html>
