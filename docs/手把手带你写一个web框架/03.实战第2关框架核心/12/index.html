<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-front/umi.css" />
    <script>
      window.routerBase = "/blog-front";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>16｜配置和环境（下）：配置服务中的设计思路 - 大师兄</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/手把手带你写一个web框架/03.实战第2关框架核心/12" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-front/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>算法<ul><li><a href="/blog-front/业务开发算法50讲">业务开发算法50讲</a></li></ul></span><span>前端开发<ul><li><a href="/blog-front/浏览器工作原理与实践">浏览器工作原理与实践</a></li><li><a href="/blog-front/flutter核心技术与实战">flutter核心技术与实战</a></li><li><a href="/blog-front/java-script核心原理解析">java-script核心原理解析</a></li><li><a href="/blog-front/nodejs应用开发实战">nodejs应用开发实战</a></li><li><a href="/blog-front/反爬虫兵法演绎20讲">反爬虫兵法演绎20讲</a></li><li><a href="/blog-front/reactnative新架构实战课">reactnative新架构实战课</a></li><li><a href="/blog-front/重学前端">重学前端</a></li><li><a href="/blog-front/serverless入门课">serverless入门课</a></li><li><a href="/blog-front/type-script入门实战笔记">type-script入门实战笔记</a></li><li><a href="/blog-front/图解googlev8">图解googlev8</a></li><li><a href="/blog-front/vue3源码分析">vue3源码分析</a></li><li><a href="/blog-front/玩转Vue3全家桶">玩转Vue3全家桶</a></li><li><a href="/blog-front/webassembly入门">webassembly入门</a></li><li><a aria-current="page" class="active" href="/blog-front/手把手带你写一个Web框架">手把手带你写一个Web框架</a></li><li><a href="/blog-front/web漏洞挖掘实战">web漏洞挖掘实战</a></li><li><a href="/blog-front/跟月影学可视化">跟月影学可视化</a></li><li><a href="/blog-front/搞定音频技术">搞定音频技术</a></li><li><a href="/blog-front/攻克视频技术">攻克视频技术</a></li></ul></span><span>前端工程化<ul><li><a href="/blog-front/logger">logger</a></li><li><a href="/blog-front/webpack">webpack</a></li><li><a href="/blog-front/webpackchain">webpackchain</a></li></ul></span><span>前端性能优化<ul><li><a href="/blog-front/react性能调优">react性能调优</a></li></ul></span><span>移动端开发<ul><li><a href="/blog-front/android开发高手课">android开发高手课</a></li><li><a href="/blog-front/ios开发高手课">ios开发高手课</a></li></ul></span><span>产品与用户体验<ul><li><a href="/blog-front/视觉笔记入门课">视觉笔记入门课</a></li></ul></span><span>杂谈<ul><li><a href="/blog-front/git实战手册">git实战手册</a></li><li><a href="/blog-front/nodejs">nodejs</a></li><li><a href="/blog-front/reactjs">reactjs</a></li><li><a href="/blog-front/ui设计">ui设计</a></li><li><a href="/blog-front/webpack4系列教程">webpack4系列教程</a></li><li><a href="/blog-front/前端知识体系">前端知识体系</a></li><li><a href="/blog-front/剑指offer刷题笔记">剑指offer刷题笔记</a></li><li><a href="/blog-front/思考与成长">思考与成长</a></li><li><a href="/blog-front/设计模式手册">设计模式手册</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-front/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>算法<ul><li><a href="/blog-front/业务开发算法50讲">业务开发算法50讲</a></li></ul></li><li>前端开发<ul><li><a href="/blog-front/浏览器工作原理与实践">浏览器工作原理与实践</a></li><li><a href="/blog-front/flutter核心技术与实战">flutter核心技术与实战</a></li><li><a href="/blog-front/java-script核心原理解析">java-script核心原理解析</a></li><li><a href="/blog-front/nodejs应用开发实战">nodejs应用开发实战</a></li><li><a href="/blog-front/反爬虫兵法演绎20讲">反爬虫兵法演绎20讲</a></li><li><a href="/blog-front/reactnative新架构实战课">reactnative新架构实战课</a></li><li><a href="/blog-front/重学前端">重学前端</a></li><li><a href="/blog-front/serverless入门课">serverless入门课</a></li><li><a href="/blog-front/type-script入门实战笔记">type-script入门实战笔记</a></li><li><a href="/blog-front/图解googlev8">图解googlev8</a></li><li><a href="/blog-front/vue3源码分析">vue3源码分析</a></li><li><a href="/blog-front/玩转Vue3全家桶">玩转Vue3全家桶</a></li><li><a href="/blog-front/webassembly入门">webassembly入门</a></li><li><a aria-current="page" class="active" href="/blog-front/手把手带你写一个Web框架">手把手带你写一个Web框架</a></li><li><a href="/blog-front/web漏洞挖掘实战">web漏洞挖掘实战</a></li><li><a href="/blog-front/跟月影学可视化">跟月影学可视化</a></li><li><a href="/blog-front/搞定音频技术">搞定音频技术</a></li><li><a href="/blog-front/攻克视频技术">攻克视频技术</a></li></ul></li><li>前端工程化<ul><li><a href="/blog-front/logger">logger</a></li><li><a href="/blog-front/webpack">webpack</a></li><li><a href="/blog-front/webpackchain">webpackchain</a></li></ul></li><li>前端性能优化<ul><li><a href="/blog-front/react性能调优">react性能调优</a></li></ul></li><li>移动端开发<ul><li><a href="/blog-front/android开发高手课">android开发高手课</a></li><li><a href="/blog-front/ios开发高手课">ios开发高手课</a></li></ul></li><li>产品与用户体验<ul><li><a href="/blog-front/视觉笔记入门课">视觉笔记入门课</a></li></ul></li><li>杂谈<ul><li><a href="/blog-front/git实战手册">git实战手册</a></li><li><a href="/blog-front/nodejs">nodejs</a></li><li><a href="/blog-front/reactjs">reactjs</a></li><li><a href="/blog-front/ui设计">ui设计</a></li><li><a href="/blog-front/webpack4系列教程">webpack4系列教程</a></li><li><a href="/blog-front/前端知识体系">前端知识体系</a></li><li><a href="/blog-front/剑指offer刷题笔记">剑指offer刷题笔记</a></li><li><a href="/blog-front/思考与成长">思考与成长</a></li><li><a href="/blog-front/设计模式手册">设计模式手册</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-front/">大师兄 - 前端架构师</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="配置服务的设计" data-depth="2"><a href="/blog-front/手把手带你写一个web框架/03.实战第2关框架核心/12#配置服务的设计"><span>配置服务的设计</span></a></li><li title="配置文件的读取" data-depth="3"><a href="/blog-front/手把手带你写一个web框架/03.实战第2关框架核心/12#配置文件的读取"><span>配置文件的读取</span></a></li><li title="配置文件的替换" data-depth="3"><a href="/blog-front/手把手带你写一个web框架/03.实战第2关框架核心/12#配置文件的替换"><span>配置文件的替换</span></a></li><li title="配置项的解析" data-depth="3"><a href="/blog-front/手把手带你写一个web框架/03.实战第2关框架核心/12#配置项的解析"><span>配置项的解析</span></a></li><li title="配置服务的代码实现" data-depth="2"><a href="/blog-front/手把手带你写一个web框架/03.实战第2关框架核心/12#配置服务的代码实现"><span>配置服务的代码实现</span></a></li><li title="配置文件更新App服务" data-depth="2"><a href="/blog-front/手把手带你写一个web框架/03.实战第2关框架核心/12#配置文件更新app服务"><span>配置文件更新App服务</span></a></li><li title="配置文件热更新" data-depth="2"><a href="/blog-front/手把手带你写一个web框架/03.实战第2关框架核心/12#配置文件热更新"><span>配置文件热更新</span></a></li><li title="验证" data-depth="2"><a href="/blog-front/手把手带你写一个web框架/03.实战第2关框架核心/12#验证"><span>验证</span></a></li><li title="小结" data-depth="2"><a href="/blog-front/手把手带你写一个web框架/03.实战第2关框架核心/12#小结"><span>小结</span></a></li><li title="思考题" data-depth="2"><a href="/blog-front/手把手带你写一个web框架/03.实战第2关框架核心/12#思考题"><span>思考题</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="16配置和环境下配置服务中的设计思路"><a aria-hidden="true" tabindex="-1" href="/blog-front/手把手带你写一个web框架/03.实战第2关框架核心/12#16配置和环境下配置服务中的设计思路"><span class="icon icon-link"></span></a>16｜配置和环境（下）：配置服务中的设计思路</h1><p>你好，我是轩脉刃。</p><p>上一节课，我们已经定义好了配置文件服务的接口，这节课就来实现这些接口。先来规划配置文件服务目录，按照上一节课分析的，多个配置文件按类别放在不同配置文件夹中，在框架文件夹中，我们将配置文件接口代码写在框架文件夹下的contract/config.go文件中，将具体实现放在provider/config/目录中。</p><h2 id="配置服务的设计"><a aria-hidden="true" tabindex="-1" href="/blog-front/手把手带你写一个web框架/03.实战第2关框架核心/12#配置服务的设计"><span class="icon icon-link"></span></a>配置服务的设计</h2><p>不过设计优于实现，动手之前我们先思考下实现这个接口要如何设计。</p><p>首先，要读取一下配置文件夹中的文件。上节课说了，最终的配置文件夹地址为，应用服务的 ConfigFolder 下的环境变量对应的文件夹，比如 ConfigFolder/development。但是还有一个问题，就是配置文件的格式的选择。</p><p><strong>目前市面上的配置文件格式非常多，但是很难说哪种配置文件比较好，完全是不同平台、不同时代下的产物</strong>。比如Windows开发的配置常用INI、Java开发配置常用Properties，我这里选择了使用YAML格式。</p><h3 id="配置文件的读取"><a aria-hidden="true" tabindex="-1" href="/blog-front/手把手带你写一个web框架/03.实战第2关框架核心/12#配置文件的读取"><span class="icon icon-link"></span></a>配置文件的读取</h3><p>YAML格式是在Golang的项目中比较通用的一种格式，比如Kubernetes、Docker、Swagger等项目，都是使用YAML作为其配置文件的。YAML配置文件除了能表达基础类型比如string、int、float 之外，也能表达复杂的数组、结构等数据类型。</p><p>目前最新的YAML版本为1.2版本，配置的说明文档在<a target="_blank" rel="noopener noreferrer" href="https://yaml.org/">官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>上。它提供多种语言的解析库，其中<a target="_blank" rel="noopener noreferrer" href="https://github.com/go-yaml/yaml">go-yaml<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 就是非常通用的一个Go解析库，这个库的封装性非常好。</p><p>我们通过第一节课讲的快速阅读一个库的命令 <code>go doc github.com/go-yaml/yaml |grep &#x27;^func&#x27;</code>，可以看出来这个库对外提供的方法非常明确，一共三个方法：</p><ul><li>Marshal 表示序列化一个结构成为YAML格式；</li><li>Unmarshal表示反序列化一个YAML格式文本成为一个结构；</li><li>还有一个UnmarshalStrict 函数，表示严格反序列化，比如如果YAML格式文件中包含重复key的字段，那么使用UnmarshalStrict 函数反序列化会出现错误。</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// 序列化</span></div><div class="token-line"><span class="token plain">    func Marshal(in interface{}) (out []byte, err error)</span></div><div class="token-line"><span class="token plain">    // 反序列化</span></div><div class="token-line"><span class="token plain">    func Unmarshal(in []byte, out interface{}) (err error)</span></div><div class="token-line"><span class="token plain">    // 严格反序列化</span></div><div class="token-line"><span class="token plain">    func UnmarshalStrict(in []byte, out interface{}) (err error)</span></div></pre></div><p>我们选择Unmarshal的函数进行反序列化，因为这样能提高框架对配置文件的容错性和易用性。好，读取配置文件的格式和对应工具搞定，下一步就是想清楚怎么替换了。</p><h3 id="配置文件的替换"><a aria-hidden="true" tabindex="-1" href="/blog-front/手把手带你写一个web框架/03.实战第2关框架核心/12#配置文件的替换"><span class="icon icon-link"></span></a>配置文件的替换</h3><p>在上一节课说的环境变量服务中，存放了包括.env中设置的环境变量，那么我们自然会希望使用上这些环境变量，把配置文件中有的字段使用环境变量替换掉。那么这里在配置文件中就需要有一个“占位符”。这个占位符表示当前这个字段去环境变量中进行阅读。</p><p>这个占位符的设计只有一个要求：够特别。只要这个占位符能和其他配置文件字符区分开就行，所以这里设计占位符为比较有语义的“env(XXXX)”。比如app/config/development/database.yaml 文件中的数据库密码，使用占位符表示如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">mysql:</span></div><div class="token-line"><span class="token plain">      hostname: 127.0.0.1</span></div><div class="token-line"><span class="token plain">      username: yejianfeng</span></div><div class="token-line"><span class="token plain">      password: env(DB_PASSWORD)</span></div><div class="token-line"><span class="token plain">      timeout: 1</span></div><div class="token-line"><span class="token plain">      readtime: 2.3</span></div></pre></div><p>要实现这个功能，其实也很简单，可以在读取YAML配置文件内容之后，进行完整的文本匹配，将所有环境变量env(xxx) 的字符替换为环境变量。我们应该能设计出替换文本的函数。</p><p>在框架目录的provider/config/service.go中，可以先实现这个方法。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// replace 表示使用环境变量maps替换context中的env(xxx)的环境变量</span></div><div class="token-line"><span class="token plain">    func replace(content []byte, maps map[string]string) []byte {</span></div><div class="token-line"><span class="token plain">       if maps == nil {</span></div><div class="token-line"><span class="token plain">          return content</span></div><div class="token-line"><span class="token plain">       }</span></div><div class="token-line"><span class="token plain">       // 直接使用ReplaceAll替换。这个性能可能不是最优，但是配置文件加载，频率是比较低的，可以接受</span></div><div class="token-line"><span class="token plain">       for key, val := range maps {</span></div><div class="token-line"><span class="token plain">          reKey := &quot;env(&quot; + key + &quot;)&quot;</span></div><div class="token-line"><span class="token plain">          content = bytes.ReplaceAll(content, []byte(reKey), []byte(val))</span></div><div class="token-line"><span class="token plain">       }</span></div><div class="token-line"><span class="token plain">       return content</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><h3 id="配置项的解析"><a aria-hidden="true" tabindex="-1" href="/blog-front/手把手带你写一个web框架/03.实战第2关框架核心/12#配置项的解析"><span class="icon icon-link"></span></a>配置项的解析</h3><p>读取并解析完配置文件内容，接下来就要根据path来解析某个配置项了。上一节课说，我们使用点号分割的路径读取方式，比如database.mysql.password 表示在配置文件夹中的database.yaml文件，其中的mysql配置，对应的是数据结构中的password字段。</p><p>那这种根据path来读取字段应该怎么实现呢？</p><p>在获取配置项的时候，我们已经通过go-yaml库将配置文件解析到一个map数据结构中了，而这个map数据结构的子项，明显也有可能是一个map数据结构。所以按照path路径查找，这明显应该是一个<strong>函数递归逻辑</strong>。</p><p>还是用刚才的database.mysql.password举例，可以拆分为3个结构。database 去根map中寻找；如果有这个key，就拿着mysql.password的path，去 database这个key对应的value中进行寻找；而递归寻找到了最后一级path为password，发现这个path没有下一级了，就停止递归。</p><p>详细的代码方法如下，同样存放在框架目录的provider/config/service.go中。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// 查找某个路径的配置项</span></div><div class="token-line"><span class="token plain">    func searchMap(source map[string]interface{}, path []string) interface{} {</span></div><div class="token-line"><span class="token plain">       if len(path) == 0 {</span></div><div class="token-line"><span class="token plain">          return source</span></div><div class="token-line"><span class="token plain">       }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">       // 判断是否有下个路径</span></div><div class="token-line"><span class="token plain">       next, ok := source[path[0]]</span></div><div class="token-line"><span class="token plain">       if ok {</span></div><div class="token-line"><span class="token plain">          // 判断这个路径是否为1</span></div><div class="token-line"><span class="token plain">          if len(path) == 1 {</span></div><div class="token-line"><span class="token plain">             return next</span></div><div class="token-line"><span class="token plain">          }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">          // 判断下一个路径的类型</span></div><div class="token-line"><span class="token plain">          switch next.(type) {</span></div><div class="token-line"><span class="token plain">          case map[interface{}]interface{}:</span></div><div class="token-line"><span class="token plain">             // 如果是interface的map，使用cast进行下value转换</span></div><div class="token-line"><span class="token plain">             return searchMap(cast.ToStringMap(next), path[1:])</span></div><div class="token-line"><span class="token plain">          case map[string]interface{}:</span></div><div class="token-line"><span class="token plain">             // 如果是map[string]，直接循环调用</span></div><div class="token-line"><span class="token plain">             return searchMap(next.(map[string]interface{}), path[1:])</span></div><div class="token-line"><span class="token plain">          default:</span></div><div class="token-line"><span class="token plain">             // 否则的话，返回nil</span></div><div class="token-line"><span class="token plain">             return nil</span></div><div class="token-line"><span class="token plain">          }</span></div><div class="token-line"><span class="token plain">       }</span></div><div class="token-line"><span class="token plain">       return nil</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    // 通过path获取某个元素</span></div><div class="token-line"><span class="token plain">    func (conf *HadeConfig) find(key string) interface{} {</span></div><div class="token-line"><span class="token plain">       ...</span></div><div class="token-line"><span class="token plain">       return searchMap(conf.confMaps, strings.Split(key, conf.keyDelim))</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>想通了以上三个核心实现难点，我们就可以着手整体代码实现了。</p><h2 id="配置服务的代码实现"><a aria-hidden="true" tabindex="-1" href="/blog-front/手把手带你写一个web框架/03.实战第2关框架核心/12#配置服务的代码实现"><span class="icon icon-link"></span></a>配置服务的代码实现</h2><p>首先，在框架文件夹的provider/config/service.go 中，创建一个配置文件服务HadeConfig。它有几个属性：folder代表配置本地配置文件所在的文件夹；keyDelim代表路径中的分割符号，也就是点；envMaps存放所有的环境变量；而confMaps存放每个配置解析后的结构，confRaws存放每个配置的原始文件信息。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// HadeConfig  表示hade框架的配置文件服务</span></div><div class="token-line"><span class="token plain">    type HadeConfig struct {</span></div><div class="token-line"><span class="token plain">       c        framework.Container    // 容器</span></div><div class="token-line"><span class="token plain">       folder   string                 // 文件夹</span></div><div class="token-line"><span class="token plain">       keyDelim string                 // 路径的分隔符，默认为点</span></div><div class="token-line"><span class="token plain">       ...</span></div><div class="token-line"><span class="token plain">       envMaps  map[string]string      // 所有的环境变量</span></div><div class="token-line"><span class="token plain">       confMaps map[string]interface{} // 配置文件结构，key为文件名</span></div><div class="token-line"><span class="token plain">       confRaws map[string][]byte      // 配置文件的原始信息</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>我们初始化这个HadeConfig的函数，它从服务提供者provider/config/provider.go中获取到三个参数，除了容器之外，另外两个是文件夹地址和所有的环境变量。</p><p>我们这里对provider.go 只列一下参数函数，其他的四个服务提供者函数(Register、Boot、IsDefer、Name) 可以参考<a target="_blank" rel="noopener noreferrer" href="https://github.com/gohade/coredemo/blob/geekbang/16/framework/provider/config/provider.go">GitHub上的代码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// Paramas 服务提供者实例化的时候参数</span></div><div class="token-line"><span class="token plain">    func (provider *HadeConfigProvider) Params(c framework.Container) []interface{} {</span></div><div class="token-line"><span class="token plain">       appService := c.MustMake(contract.AppKey).(contract.App)</span></div><div class="token-line"><span class="token plain">       envService := c.MustMake(contract.EnvKey).(contract.Env)</span></div><div class="token-line"><span class="token plain">       env := envService.AppEnv()</span></div><div class="token-line"><span class="token plain">       // 配置文件夹地址</span></div><div class="token-line"><span class="token plain">       configFolder := appService.ConfigFolder()</span></div><div class="token-line"><span class="token plain">       envFolder := filepath.Join(configFolder, env)</span></div><div class="token-line"><span class="token plain">       // 传递容器，配置文件夹地址，所有环境变量</span></div><div class="token-line"><span class="token plain">       return []interface{}{c, envFolder, envService.All()}</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>那么在provider/config/service.go中，实例化的函数逻辑如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// NewHadeConfig 初始化Config方法</span></div><div class="token-line"><span class="token plain">    func NewHadeConfig(params ...interface{}) (interface{}, error) {</span></div><div class="token-line"><span class="token plain">       container := params[0].(framework.Container)</span></div><div class="token-line"><span class="token plain">       envFolder := params[1].(string)</span></div><div class="token-line"><span class="token plain">       envMaps := params[2].(map[string]string)</span></div><div class="token-line"><span class="token plain">       </span></div><div class="token-line"><span class="token plain">       // 检查文件夹是否存在</span></div><div class="token-line"><span class="token plain">       if _, err := os.Stat(envFolder); os.IsNotExist(err) {</span></div><div class="token-line"><span class="token plain">          return nil, errors.New(&quot;folder &quot; + envFolder + &quot; not exist: &quot; + err.Error())</span></div><div class="token-line"><span class="token plain">       }</span></div><div class="token-line"><span class="token plain">       // 实例化</span></div><div class="token-line"><span class="token plain">       hadeConf := &amp;HadeConfig{</span></div><div class="token-line"><span class="token plain">          c:        container,</span></div><div class="token-line"><span class="token plain">          folder:   envFolder,</span></div><div class="token-line"><span class="token plain">          envMaps:  envMaps,</span></div><div class="token-line"><span class="token plain">          confMaps: map[string]interface{}{},</span></div><div class="token-line"><span class="token plain">          confRaws: map[string][]byte{},</span></div><div class="token-line"><span class="token plain">          keyDelim: &quot;.&quot;,</span></div><div class="token-line"><span class="token plain">          lock:     sync.RWMutex{},</span></div><div class="token-line"><span class="token plain">       }</span></div><div class="token-line"><span class="token plain">       // 读取每个文件</span></div><div class="token-line"><span class="token plain">       files, err := ioutil.ReadDir(envFolder)</span></div><div class="token-line"><span class="token plain">       if err != nil {</span></div><div class="token-line"><span class="token plain">          return nil, errors.WithStack(err)</span></div><div class="token-line"><span class="token plain">       }</span></div><div class="token-line"><span class="token plain">       for _, file := range files {</span></div><div class="token-line"><span class="token plain">          fileName := file.Name()</span></div><div class="token-line"><span class="token plain">          err := hadeConf.loadConfigFile(envFolder, fileName)</span></div><div class="token-line"><span class="token plain">          if err != nil {</span></div><div class="token-line"><span class="token plain">             log.Println(err)</span></div><div class="token-line"><span class="token plain">             continue</span></div><div class="token-line"><span class="token plain">          }</span></div><div class="token-line"><span class="token plain">       }</span></div><div class="token-line"><span class="token plain">       ...</span></div><div class="token-line"><span class="token plain">       return hadeConf, nil</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    // 读取某个配置文件</span></div><div class="token-line"><span class="token plain">    func (conf *HadeConfig) loadConfigFile(folder string, file string) error {</span></div><div class="token-line"><span class="token plain">       conf.lock.Lock()</span></div><div class="token-line"><span class="token plain">       defer conf.lock.Unlock()</span></div><div class="token-line"><span class="token plain">       //  判断文件是否以yaml或者yml作为后缀</span></div><div class="token-line"><span class="token plain">       s := strings.Split(file, &quot;.&quot;)</span></div><div class="token-line"><span class="token plain">       if len(s) == 2 &amp;&amp; (s[1] == &quot;yaml&quot; || s[1] == &quot;yml&quot;) {</span></div><div class="token-line"><span class="token plain">          name := s[0]</span></div><div class="token-line"><span class="token plain">          // 读取文件内容</span></div><div class="token-line"><span class="token plain">          bf, err := ioutil.ReadFile(filepath.Join(folder, file))</span></div><div class="token-line"><span class="token plain">          if err != nil {</span></div><div class="token-line"><span class="token plain">             return err</span></div><div class="token-line"><span class="token plain">          }</span></div><div class="token-line"><span class="token plain">          // 直接针对文本做环境变量的替换</span></div><div class="token-line"><span class="token plain">          bf = replace(bf, conf.envMaps)</span></div><div class="token-line"><span class="token plain">          // 解析对应的文件</span></div><div class="token-line"><span class="token plain">          c := map[string]interface{}{}</span></div><div class="token-line"><span class="token plain">          if err := yaml.Unmarshal(bf, &amp;c); err != nil {</span></div><div class="token-line"><span class="token plain">             return err</span></div><div class="token-line"><span class="token plain">          }</span></div><div class="token-line"><span class="token plain">          conf.confMaps[name] = c</span></div><div class="token-line"><span class="token plain">          conf.confRaws[name] = bf</span></div><div class="token-line"><span class="token plain">       }</span></div><div class="token-line"><span class="token plain">       return nil</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>逻辑非常清晰。先检查配置文件夹是否存在，然后读取文件夹中的每个以yaml或者yml后缀的文件；读取之后，先用replace对环境变量进行一次替换；替换之后使用 go-yaml，对文件进行解析。</p><p>初始化实例就是一个完整的 解析文件的过程，解析结束之后，confMaps里存放的就是解析之后的结果。</p><p>配置文件的获取接口上节课已经写好了，定义了接口的系列方法，这里我们就详细实现Get/GetBool/GetInt，其他方法大同小异，就不贴出来了，你可以直接参考<a target="_blank" rel="noopener noreferrer" href="https://github.com/gohade/coredemo/blob/geekbang/16/framework/provider/config/service.go">GitHub上的代码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p><p>前面已经想好了，用方法find，通过path，从一个嵌套map confMaps中获取数据。所以Get方法就是调用一下find方法而已，同样也在service.go中：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// Get 获取某个配置项</span></div><div class="token-line"><span class="token plain">    func (conf *HadeConfig) Get(key string) interface{} {</span></div><div class="token-line"><span class="token plain">       return conf.find(key)</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>而对应的Get系列的方法我们使用cast库进行类型转换，比如：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// GetBool 获取bool类型配置</span></div><div class="token-line"><span class="token plain">    func (conf *HadeConfig) GetBool(key string) bool {</span></div><div class="token-line"><span class="token plain">       return cast.ToBool(conf.find(key))</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    // GetInt 获取int类型配置</span></div><div class="token-line"><span class="token plain">    func (conf *HadeConfig) GetInt(key string) int {</span></div><div class="token-line"><span class="token plain">       return cast.ToInt(conf.find(key))</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>到这里，配置服务的代码已经基本成型了。但是实际上还有两个细节我们需要认真思考。</p><p>首先，因为之前我们设置过App服务，将一个App服务的目录都安排好了，但是如果之后有需求要改变这些目录的配置呢？如果有的话，是否可以通过配置来进行修改呢？所以第一个问题就是，我们要思考配置文件更新App服务的操作。</p><p>其次，假设现在配置服务能从文件中获取配置了，但是如果文件修改了，我们是否需要重新启动应用呢？是否有能不启动应用的方法呢？</p><p>下面我们来一一解决这两个问题。</p><h2 id="配置文件更新app服务"><a aria-hidden="true" tabindex="-1" href="/blog-front/手把手带你写一个web框架/03.实战第2关框架核心/12#配置文件更新app服务"><span class="icon icon-link"></span></a>配置文件更新App服务</h2><p>现在有了配置文件服务，但在没有配置文件服务之前，我们启动服务的appService，也是有可能要修改这个服务的配置的。回忆<a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/423982">第十二<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/423982">课<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，appService中存放了启动这个业务实例默认设置的文件夹目录和地址。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">//BaseFolder 定义项目基础地址</span></div><div class="token-line"><span class="token plain">    BaseFolder() string</span></div><div class="token-line"><span class="token plain">    // ConfigFolder 定义了配置文件的路径</span></div><div class="token-line"><span class="token plain">    ConfigFolder() string</span></div><div class="token-line"><span class="token plain">    // LogFolder 定义了日志所在路径</span></div><div class="token-line"><span class="token plain">    LogFolder() string</span></div><div class="token-line"><span class="token plain">    // ProviderFolder 定义业务自己的服务提供者地址</span></div><div class="token-line"><span class="token plain">    ProviderFolder() string</span></div><div class="token-line"><span class="token plain">    // MiddlewareFolder 定义业务自己定义的中间件</span></div><div class="token-line"><span class="token plain">    MiddlewareFolder() string</span></div><div class="token-line"><span class="token plain">    // CommandFolder 定义业务定义的命令</span></div><div class="token-line"><span class="token plain">    CommandFolder() string</span></div><div class="token-line"><span class="token plain">    // RuntimeFolder 定义业务的运行中间态信息</span></div><div class="token-line"><span class="token plain">    RuntimeFolder() string</span></div><div class="token-line"><span class="token plain">    // TestFolder 存放测试所需要的信息</span></div><div class="token-line"><span class="token plain">    TestFolder() string</span></div></pre></div><p>现在有需求将这些文件夹目录，在配置文件中进行配置并修改。所以应该在加载到配置服务时，再更新下appService。加载逻辑如下：</p><p><img src="/blog-front/static/httpsstatic001geekbangorgresourceimagef5eef5141333501ce140314fb985b75c6eee.1f46706f.jpg" alt="图片"/></p><p>可以把设定App的这些配置文件，存放在配置文件夹的app.yaml文件的path设置项下，其中每个配置项的key，对应appService中每个对应的服务。比如log_folder对应LogFolder目录：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">path:</span></div><div class="token-line"><span class="token plain">      log_folder: &quot;/home/jianfengye/hade/log/&quot;</span></div><div class="token-line"><span class="token plain">      runtime_folder: &quot;/home/jianfengye/hade/runtime/&quot;</span></div></pre></div><p>现在加载配置服务的时候，当读取到配置服务app.path下有内容，就需要更新appService的配置。首先需要修改appService，修改框架目录下的provider/app/service.go文件。</p><p>将HadeApp增加一个configMap字段：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// HadeApp 代表hade框架的App实现</span></div><div class="token-line"><span class="token plain">    type HadeApp struct {</span></div><div class="token-line"><span class="token plain">       ...</span></div><div class="token-line"><span class="token plain">       configMap map[string]string // 配置加载</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>同时为HadeApp增加LoadAppConfig方法，用于读取配置文件中的信息：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// LoadAppConfig 加载配置map</span></div><div class="token-line"><span class="token plain">    func (app *HadeApp) LoadAppConfig(kv map[string]string) {</span></div><div class="token-line"><span class="token plain">       for key, val := range kv {</span></div><div class="token-line"><span class="token plain">          app.configMap[key] = val</span></div><div class="token-line"><span class="token plain">       }</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>再修改对应的LogFolder等一系列XXXFolder的方法，先读取configMap中的值，如果有的话，先用configMap中的值：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// LogFolder 表示日志存放地址</span></div><div class="token-line"><span class="token plain">    func (app HadeApp) LogFolder() string {</span></div><div class="token-line"><span class="token plain">       if val, ok := app.configMap[&quot;log_folder&quot;]; ok {</span></div><div class="token-line"><span class="token plain">          return val</span></div><div class="token-line"><span class="token plain">       }</span></div><div class="token-line"><span class="token plain">       return filepath.Join(app.StorageFolder(), &quot;log&quot;)</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>这样，对appService的修改就完成了。</p><p>在configService，读取配置文件loadConfigFile的时候，要注意，如果当前的配置文件是app.yaml， 我们需要调用appService的LoadAppConfig方法：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// 读取某个配置文件</span></div><div class="token-line"><span class="token plain">    func (conf *HadeConfig) loadConfigFile(folder string, file string) error {</span></div><div class="token-line"><span class="token plain">       ...</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">       //  判断文件是否以yaml或者yml作为后缀</span></div><div class="token-line"><span class="token plain">       s := strings.Split(file, &quot;.&quot;)</span></div><div class="token-line"><span class="token plain">       if len(s) == 2 &amp;&amp; (s[1] == &quot;yaml&quot; || s[1] == &quot;yml&quot;) {</span></div><div class="token-line"><span class="token plain">          name := s[0]</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">          ...</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">          // 读取app.path中的信息，更新app对应的folder</span></div><div class="token-line"><span class="token plain">          if name == &quot;app&quot; &amp;&amp; conf.c.IsBind(contract.AppKey) {</span></div><div class="token-line"><span class="token plain">             if p, ok := c[&quot;path&quot;]; ok {</span></div><div class="token-line"><span class="token plain">                appService := conf.c.MustMake(contract.AppKey).(contract.App)</span></div><div class="token-line"><span class="token plain">                appService.LoadAppConfig(cast.ToStringMapString(p))</span></div><div class="token-line"><span class="token plain">             }</span></div><div class="token-line"><span class="token plain">          }</span></div><div class="token-line"><span class="token plain">       }</span></div><div class="token-line"><span class="token plain">       return nil</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>这样在加载app.yaml的配置文件的时候，就同时更新了appService 里面的配置。</p><h2 id="配置文件热更新"><a aria-hidden="true" tabindex="-1" href="/blog-front/手把手带你写一个web框架/03.实战第2关框架核心/12#配置文件热更新"><span class="icon icon-link"></span></a>配置文件热更新</h2><p>正常来说，在程序启动的时候会读取一次配置文件，但是在程序运行过程中，我们难免会遇到需要修改配置文件的操作。也就是之前思考的第二个问题。</p><p>这个时候，是否需要重新启动一次程序再加载一次配置文件呢？这当然是没有问题的，但是更为强大的是，<strong>我们可以自动监控配置文件目录下的所有文件，当配置文件有修改和更新的时候，能自动更新程序中的配置文件信息，也就是实现配置文件热更新</strong>。</p><p>这个热更新看起来很麻烦，其实在Golang中是非常简单的事情。我们使用 <a target="_blank" rel="noopener noreferrer" href="https://github.com/fsnotify/fsnotify">fsnotify<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 库能很方便对一个文件夹进行监控，当文件夹中有文件增/删/改的时候，会通过channel进行事件回调。</p><p>这个库的使用方式很简单。大致思路就是先使用NewWatcher创建一个监控器watcher，然后使用Add来监控某个文件夹，通过watcher设置的events来判断文件是否有变化，如果有变化，就进行对应的操作，比如更新内存中配置服务存储的map结构。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// NewHadeConfig 初始化Config方法</span></div><div class="token-line"><span class="token plain">    func NewHadeConfig(params ...interface{}) (interface{}, error) {</span></div><div class="token-line"><span class="token plain">       ...</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">       // 监控文件夹文件</span></div><div class="token-line"><span class="token plain">       watch, err := fsnotify.NewWatcher()</span></div><div class="token-line"><span class="token plain">       if err != nil {</span></div><div class="token-line"><span class="token plain">          return nil, err</span></div><div class="token-line"><span class="token plain">       }</span></div><div class="token-line"><span class="token plain">       err = watch.Add(envFolder)</span></div><div class="token-line"><span class="token plain">       if err != nil {</span></div><div class="token-line"><span class="token plain">          return nil, err</span></div><div class="token-line"><span class="token plain">       }</span></div><div class="token-line"><span class="token plain">       go func() {</span></div><div class="token-line"><span class="token plain">          defer func() {</span></div><div class="token-line"><span class="token plain">             if err := recover(); err != nil {</span></div><div class="token-line"><span class="token plain">                fmt.Println(err)</span></div><div class="token-line"><span class="token plain">             }</span></div><div class="token-line"><span class="token plain">          }()</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">          for {</span></div><div class="token-line"><span class="token plain">             select {</span></div><div class="token-line"><span class="token plain">             case ev := &lt;-watch.Events:</span></div><div class="token-line"><span class="token plain">                {</span></div><div class="token-line"><span class="token plain">                   //判断事件发生的类型，如下5种</span></div><div class="token-line"><span class="token plain">                   // Create 创建</span></div><div class="token-line"><span class="token plain">                   // Write 写入</span></div><div class="token-line"><span class="token plain">                   // Remove 删除</span></div><div class="token-line"><span class="token plain">                   path, _ := filepath.Abs(ev.Name)</span></div><div class="token-line"><span class="token plain">                   index := strings.LastIndex(path, string(os.PathSeparator))</span></div><div class="token-line"><span class="token plain">                   folder := path[:index]</span></div><div class="token-line"><span class="token plain">                   fileName := path[index+1:]</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">                   if ev.Op&amp;fsnotify.Create == fsnotify.Create {</span></div><div class="token-line"><span class="token plain">                      log.Println(&quot;创建文件 : &quot;, ev.Name)</span></div><div class="token-line"><span class="token plain">                      hadeConf.loadConfigFile(folder, fileName)</span></div><div class="token-line"><span class="token plain">                   }</span></div><div class="token-line"><span class="token plain">                   if ev.Op&amp;fsnotify.Write == fsnotify.Write {</span></div><div class="token-line"><span class="token plain">                      log.Println(&quot;写入文件 : &quot;, ev.Name)</span></div><div class="token-line"><span class="token plain">                      hadeConf.loadConfigFile(folder, fileName)</span></div><div class="token-line"><span class="token plain">                   }</span></div><div class="token-line"><span class="token plain">                   if ev.Op&amp;fsnotify.Remove == fsnotify.Remove {</span></div><div class="token-line"><span class="token plain">                      log.Println(&quot;删除文件 : &quot;, ev.Name)</span></div><div class="token-line"><span class="token plain">                      hadeConf.removeConfigFile(folder, fileName)</span></div><div class="token-line"><span class="token plain">                   }</span></div><div class="token-line"><span class="token plain">                }</span></div><div class="token-line"><span class="token plain">             case err := &lt;-watch.Errors:</span></div><div class="token-line"><span class="token plain">                {</span></div><div class="token-line"><span class="token plain">                   log.Println(&quot;error : &quot;, err)</span></div><div class="token-line"><span class="token plain">                   return</span></div><div class="token-line"><span class="token plain">                }</span></div><div class="token-line"><span class="token plain">             }</span></div><div class="token-line"><span class="token plain">          }</span></div><div class="token-line"><span class="token plain">       }()</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">       return hadeConf, nil</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>代码如上，我们使用NewWatcher创建一个监听器，监听配置文件目录，接着启动一个新的Goroutine作为监听协程。在监听协程中，监听配置文件的创建、更新、删除操作。创建和更新对应 LoadConfigFile 操作。</p><p>而删除，对应的是 removeConfigFile操作，这个操作的内容就是删除配置服务中的confMaps中对应的key。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// 删除文件的操作</span></div><div class="token-line"><span class="token plain">    func (conf *HadeConfig) removeConfigFile(folder string, file string) error {</span></div><div class="token-line"><span class="token plain">       conf.lock.Lock()</span></div><div class="token-line"><span class="token plain">       defer conf.lock.Unlock()</span></div><div class="token-line"><span class="token plain">       s := strings.Split(file, &quot;.&quot;)</span></div><div class="token-line"><span class="token plain">       // 只有yaml或者yml后缀才执行</span></div><div class="token-line"><span class="token plain">       if len(s) == 2 &amp;&amp; (s[1] == &quot;yaml&quot; || s[1] == &quot;yml&quot;) {</span></div><div class="token-line"><span class="token plain">          name := s[0]</span></div><div class="token-line"><span class="token plain">          // 删除内存中对应的key</span></div><div class="token-line"><span class="token plain">          delete(conf.confRaws, name)</span></div><div class="token-line"><span class="token plain">          delete(conf.confMaps, name)</span></div><div class="token-line"><span class="token plain">       }</span></div><div class="token-line"><span class="token plain">       return nil</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>这里注意下，由于在运行时增加了对confMaps的写操作，所以需要对confMaps进行锁设置，以防止在写confMaps的时候，读操作进入读取了错误信息。</p><p>分析目前的这个场景，读明显多于写。所以我们的锁应该是一个读写锁，读写锁可以让多个读并发读，但是只要有一个写操作，读和写都需要等待。这个很符合当前这个场景。</p><p>所以在框架目录的provider/config/service.go中的HadeConfig，我们增加了一个读写锁lock。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// HadeConfig  表示hade框架的配置文件服务</span></div><div class="token-line"><span class="token plain">    type HadeConfig struct {</span></div><div class="token-line"><span class="token plain">       ...</span></div><div class="token-line"><span class="token plain">       lock     sync.RWMutex           // 配置文件读写锁</span></div><div class="token-line"><span class="token plain">       ...</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>而在loadConfigFile和removeConfigFile这两个对配置有修改的情况，使用写锁锁住HadeConfig。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// 读取某个配置文件</span></div><div class="token-line"><span class="token plain">    func (conf *HadeConfig) loadConfigFile(folder string, file string) error {</span></div><div class="token-line"><span class="token plain">       conf.lock.Lock()</span></div><div class="token-line"><span class="token plain">       defer conf.lock.Unlock()</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">       ...</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>在Get系列方法调用的find函数中，使用读锁来进行读操作。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">// 通过path来获取某个配置项</span></div><div class="token-line"><span class="token plain">    func (conf *HadeConfig) find(key string) interface{} {</span></div><div class="token-line"><span class="token plain">       conf.lock.RLock()</span></div><div class="token-line"><span class="token plain">       defer conf.lock.RUnlock()</span></div><div class="token-line"><span class="token plain">       ...</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>这样，配置服务就开发完成了。</p><h2 id="验证"><a aria-hidden="true" tabindex="-1" href="/blog-front/手把手带你写一个web框架/03.实战第2关框架核心/12#验证"><span class="icon icon-link"></span></a>验证</h2><p>我们先测试环境变量注入配置文件的功能。将业务目录下的config/development/database.yaml 中的mysql.password，使用环境变量进行替换。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">mysql:</span></div><div class="token-line"><span class="token plain">      hostname: 127.0.0.1</span></div><div class="token-line"><span class="token plain">      username: yejianfeng</span></div><div class="token-line"><span class="token plain">      password: env(DB_PASSWORD)</span></div><div class="token-line"><span class="token plain">      timeout: 1</span></div><div class="token-line"><span class="token plain">      readtime: 2.3</span></div></pre></div><p>然后修改业务目录下的module/demo/api.go，替换其中/demo/demo对应的路由方法。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">func (api *DemoApi) Demo(c *gin.Context) {</span></div><div class="token-line"><span class="token plain">       // 获取password</span></div><div class="token-line"><span class="token plain">       configService := c.MustMake(contract.ConfigKey).(contract.Config)</span></div><div class="token-line"><span class="token plain">       password := configService.GetString(&quot;database.mysql.password&quot;)</span></div><div class="token-line"><span class="token plain">       // 打印出来</span></div><div class="token-line"><span class="token plain">       c.JSON(200, password)</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>最后使用命令行 <code>./hade app start</code> 启动服务。打开浏览器，看到输出：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAd4AAABWCAYAAABhCvfCAAAAIGNIUk0AAHomAACAhAAA+gAAAIDoAAB1MAAA6mAAADqYAAAXcJy6UTwAAAAGYktHRAD/AP8A/6C9p5MAAAABb3JOVAHPoneaAAAhNElEQVR42u3de3zMV/748VcuIrcRpILIRYKIkKholLrF9Vt1CW3tWltFLyxfpe2uaru/Kq3WWrRKVb/ftSHiFuuylO5XXIqKurQSEYIEIYl7tHKbJDOT8/tjOp9mKpFJmkTL+/l4eEg+n/OZcz4nM/P+nHPenxm7C5euKIQQQghRJ+yUUhJ4hRBCiDpif78bIIQQQjxMJPAKIYQQdUgCrxBCCFGHHKtzkGVZWCnFz5eI7ezssLOz034WDz6j0YTRZKK0tBRTaSmSNiCEEBWrUnJVaWkpgM1vrJbAa28vA+sHUYnBQInBqD0vhBBCVM6mwGsZ2VZ3JGMZBcsI+MFgMpVSXFKC0WS6300RQojfnEoDr1KqxkY09vb2Enx/4wxGI/qi4vvdDCGE+M265xxwTQZdME9Vy/rfb5cEXSGE+OUqDLw1HXQtJPj+NplMpRJ0hRCiBtwz8NYWCbw1a3l0DMtXrKrVOopLSu73aQohxAOh3NuJqjIqLSzUM3/hIgDefectm46xjKZrKtv5myPHsLOz47HwR3F0rNYdUlVWWKgnfvdejicmcTkzCwA/Xx+Cg4MYPnQIrq4ugDkovvTC2Fprx/LoGA4eOqz9/tL452u8jhKDocqJVHp9Efv2f03yyZNkZ18BoEULb8JCQ4ns3RMXF+da6xMhhPg1c5g1a9asn2+satC9nJWNrkED+vTuaXPFNZnlnJV9hfz8fHJuf0+zpl61fvvSwYRvWPjJEk6mnOZObq62/U5uLucvXOSr/QfwaNCA+N17OXjoMMOHDamVdliCrq+vDx4eDUhJOc2tnNuEd+pYo/Xoi0uqNEtx5Mgxlv3PP0g9c5YAf3/CwzvSpnUrjAYTCYe+IeHQIRrodPj4tKhSO7Zu3Ya9vR2enp610p9lHT58hIyMDPz8/Oq87soYjUZu3bqFs7Nzhc91W8ro9Xpyc3NxcXGp8LVYWZnvv/+eQ4cO4e/vX249Rw4fwWAw0KhRo/vWX6WlpXy19ysaeDTA1dX1rv1nz54lMzOT5s2b37c2iofLXcNDW28bKht0fXxaMOPPr1apYks9NRF8Izp34th3ieTl5fHt8aRaHfkeTPhGm9bt8URXBg7oh5+vDwCXM7OI37WHg4cO1/rUb9mg+9b01wGYO/8jDiZ8A9TcyNdoNFVprf/IkWOsWReHdwtvZrwwjsaeja323865zf9Gr2TNujhcXF0IC+1g82Mv+ngRkyb/iaCgoFrtW4Avd+xAr9fTo0ePOqn7wP4DuLq58dhjnSssU1JSwrq160hNTdW2hYWF8bvf/057vttSJicnh+h/RpOTkwOY7zYYNGgQPXv9dOFsSxmAxMRE9u/bT79+/cpt865duwgPDycgIKB2/lA2yM7OJj4+ntCw0HL3JyUmcfXqVTp16nTf2igeLtWKTuUFXcvU6n05CUfHOgm+hYV61sb9CzAHth7du1nt9/P14aUXxnIzJ4ezZ9Nq7Xx/HnQtff/W9NdrPPhWZYpZry9i87+34t3Cmzd/vBgAmPrqXwBYvGgBjT0b8+b01/nb/I9Ys3Y9bWb+P5l2BtauXUuLFi3uGXg3b9pMWloaz499Hh8fHzIuZrB+/Xrc3N2IioqyqYxSimWfLcPF1YX/nvLf6HQ6jn93nB07duD5iCchISE2lbFIT0snMDDwfnffPaWnp+Pk5ESTJk3ud1OEACoY8d5LTQbdmhrxQt0E3/jdeygs1NPjia53BV2L5dEx9yXoAri6utR48K3KaHff/v3o9UXMeGFcpWUnvDCOWe9/yL79+xn05H9Vq21JSSeIiYnhyOEjtG3blqHDhvD0009r+2/evMnSpZ9xKOEQzs7O9Ordi6lTX8HJyQmAbw59w5JPPyXjonlK+Q+j/0BU1LAK6/vhhzu89trrHDl8hFatWvHqa9Po3PmnQLl16za+2LaN06dT6dIlgjHPj9H2l5aWEh29gm1bt3Hr1i06dw5nxpsz8PHxYezYcSQlJgHmKe6FHy0gODiYxMREmjZtire3NwA3btwgIDBAC3xhHcM4cOAAN67f0NpQWRmTyUR+fj6RkZH4+voCENknkvj4eG7euAkhtpUB8+s3IyODwYMHA+bR9sZ/beTMmTMADBg44K4+TE9PJz4+nqzMLJo1a0bffn3p0ME865FwMIFjx47RIbQDB/YfAGD4iOHUq1ePLZu3UFRURMuWLRk7biz169cHzFPd27Zu4/z58zg5ORHcLpjhw4dbve7TzqVZjbjj4+M5dvQYBQUFhIWFYfrZxaXJZOKLbV+QkpKC0WikXbt2jHh6hPa8mfP+HLr36E5SYhI3b97E18+X0X8YzebN5oseV1dXnhr8FOHh4drjbd26ldTTqRQXFxMQEMCwqGG/imULcX/ctShzr8Bb0yPdms5utgRfd3d3LfgajcYae/zvEk8AMHBA+dNqP090qmn3CroWluDr6+tjNS1eXaYqBN4TJ08R1qHDXdPLixctYPGiBVbbGns2JqxDB5JPnqpWuzIyMpg8aTJGg4GZ775Dh9AOzJ71Hjt2fAlAUVER06a9yrGjx5g8eRLDRwxn86bN/P3v8wG4du0af/rTJPz9/Jg1exbB7YKZ+c5Mqynan1v66VICAwJ5Y8YbFBUV8cqUqZT8mO0dH7+Lme/MpG3btsx89x1KSxUvjH+RC+cvAPDlji9ZsngJL7wwnnnz/kbO7du88cYMACZMeJnAVoF06dKFv0z/C97e3hQUFBC3Po7NmzZr9Xd7ohtp59I4lHCIq1evsn//frKysojoEmFzGUdHR8LCwti9ezepqalkZ2ezIW4DAB0f7WhzGYCrV69SWlpK6zatAVizeg3Jycn06NGD/gP6s2f3HvLz87XyN2/cJPqf0SiliBoehaurK6tjV5OVZU5OLCws5Nq1a5xMPsnQYUNp0qQJG+I2ELc+jj59+9C3X18uXLjA7t27AXOg/3zZ51y6dImBAwfS5fEuHP/uOGvXrNXqtFwctAlqA5iD+949e2nVqhVRUVFcvXqVkydPWv2dN23cxNGjR+nWrRt9+vThxIkTxMbGavvz8/PZ+X876dChAwMGDuBSxiXmzZuHyWTi6Weexs3NjQ1xGzAYDADErY/j6JGjREREMPC/BpKdnc3nyz6nuFhuz3tYVWk4OG/hIrKysgHIysrmldemV3qMn08Lm7OdK/PNkWNWL+TKWIJv1y6P1Uj9mWWyl8vz0gtjay2DuWxQz8zMuucFj6uri9bWXzryrcrF0ZXsK3QMbX/X9rJTzWW18GlOckpKtdq1Y/sOGjVqxIKFC6hfvz5PPvkkeXl5xK6KZfDgp0g8nsiplFNs2bKZwFbmqVB/Pz++PngQABcXF2JXr6J9+/Y4ODjQp08k8TvjSU4+Sbt27cqtc/CQwbwydQoAzZo1Y+KEiWRkZBAUFETsqliGDB3C9DfMr4m+ffvy7DMj+eKLL5j26jTOnDmDj48PQ4YOwdHRkdCwUC5fvoxSiu7duxO7KpYWLVrQp0+kVX0tWvyUgBYeHk7q6VS2bdumbWvfoT0dO3asUpmo4VEs+ngRMStjtG0jRoygYcOGVSqTnp6Oo6MjTZs2pbCwkLNnzzJ48GBtHdjf359lny3TyickJODs7MzEiRPNF8kREcz72zy+OfQNI383Uis3YeIE3NzcCAwMZP7f59N/QH969jQ/5tmzZ8nKzATg3Llz3Llzh1dfe5VmzZoB4O7uzrat2ygoKMDNzY1r166ZLw5amy8ODhw4QOs2rRn1h1GAeUbggzkfaHUXFxdz/PhxRowYweNdHweggUcD4tbHaY8J8FjEY9qIPisri9TTqbzw4gvY29vTpEkTln22jOvXr9PkkSYkJyczeMhg7RyCgoL4aOFHnD1zlrCOYdV6/ovftlq/9+Z+f3z+g3LP8KXMLNq2bVPlaey2bdtw6XLm/W5+jTt9OpWILhHalCNA166Ps2XzFkpKSjhz9iyNGzfWgi5Av/796NffPFvh4eFBw4YNWbN6DVeuXiUvL4+CggKK9PoK62zf/qe1zeDgtgDk3snFZDKRnJzMqFG/1/Y7OTnR5fEupKSYR/S9e/cmNnY1UcOGM3DgAHr17sWjjz56z6UWyxu1Rdz6OE6fPk2//v3M67cZGezft58tW7ZoU+yVlSkpKWHxJ4sxGAyMGDECd507x48fZ8uWLbi6uRIaGmpTGYC0tDRaBrQE4MoV8y1jwe2Ctfb+PNM5KSmJoqIi1q1bp227c+cOZ8+eteo3S3Bzd3MHwMvLS9vfoEED7vxwB4DMzEycnJy0oGv+uwSzbes2srOyCWobZHVxYDKZuHPnDr0je2vlXVxc8Pf3p6CgADAnYgEcPnyYc2nnzG38sT7LYwL4+vhqj+Hm5kajRo20c9XpdIA5szwrO0trl4WXlxfOzs5czrwsgfchVaXAO+PPr2qjXj+fFkyv46Sqbo9HVFrGaDTy7fEk8vLycHd3J6JzzWUq+vr6kJmZxeXMrApHvRaFhXqWr4jBz9enRm4nev/dvwIw7qVJVTrurTJJTtVhZ2dn88WLdwtvsrOu2vzY2VlX8W7hXa12FRYW4lTPyWqbk5M5CBuNRgwlJeXeOmKRlHSCsc+PJbBVIE9060bLli0rrbNevXrazw4ODtrPluWMek7W7XGuX5+ioiIAIrpEsGXLZnbs+JK9X+0lOnoFAwcOYP6C+Tafb3JyMk8NfopevXoB0K5dO+zt7flq71cMGzaMkpKSSsucPXOWO3fuMO3VadrtM+3bt2fJ4iXs2b2H0NBQm8oAXLxwURv1WaZVf55TUTbwWvqpga6Btq1169ZWyVlVuRXQYDDcVd7yNyoxmJcAzp07R8uWLbGzs9PWcus51rM6pmybLdO/jT0ba+10d3PH2cUZd527Vs7W3JSK+sXR0RFDicHmcxUPlrue5fd6Qrm6ujDjz6/i49OCy1nZzF+4iMJCPdVV01+YUF7Qrcnkqs4/3h8bv2tPpWXXrt/A8cQT3LqVU6PnWNccqvBG2DG0PckpKdzOuV1p2ds5t0lOSSl3atoW7duHkJycbHVRcCrlFP7+/ri6utI2uC1ZWVncunVL25+WlsbGjZsA2L1rF02bNmXTpo1Mf2M6Y8dWPwmtfv36BLYK5FSZaXOlFCdOJGuj5IL8ArxbePPK1Cls2bKZv0z/C/Hxu7h586Z2jOVNujyWN2lnZ+sMcMvvBoPBpjKWwPLzMi4uLtp6tS1lbly/gdFopE0b89qpJQHs0qVLWvnvv//eKsciNDQUT09PooZHaf9G/3G0NqVbVb6+vhQVFVktP1nqt4xIL164qLXRyckJV1dXLmZc1MqXlpaSmfnTjJCPj/mCunPnzlbtHPnsSJo2bVrlNlqWCi5fuqxtKygoID8/X0tcEw+fKgVeqNngW5OBt7aDLsDA/v1wcXHh4KHD2tppeQ4mfKOtx9bWh2fUlaqMQCJ798bZ2Zl/RK+stOz/Rq/E2dmZyN69K3/gcvTv35/U1FQ+WfQJ6enp7NjxJcuXL2fosKEAdOrUiaZNm/LWm29z6tRpvj32La9Oe42EhAQAPB95hOvXr3P06DEyMjKY8/6cX9RPUVFRrFwZwxdffEF6ejpLlnxKcnIy/QeYR4Rz5sxh2NAoUlNTuX37NpmXM7UpSoCWLVty+PARkpJOUFxcjMlk4uOPPiZ+ZzwAHg09aNy4Mdu2biM5OZmbN2+SmJjIzv/bSfPmzXFxcbGpTLsQ8/p1dHQ0Fy9e5Pr16+yK30V6ero2krWlTHp6Ovb29tqI2MPDgyZeTdi8aTOpqalcuHCB6Ohoqz4KDw8nJyeHzZs3a0lNc96fw87/21mtPm/Tpg2Ojo5E/9PcztTUVDb+ayNNmzbFo6EHN26YLw5atW6lHdOpUyeOf3ecQwmHyMrKYv369RQWFmr7dTodzZs3Z0PcBlJTU7l27RprVq9h7ty5VuVspdPp8Pb2ZtOmTZw+fZqMjAxWRK/A0dFRm7YWD59qRSZL8J33Y4bz/IWL6nzauay6CLqW8/7jqJEsX7GK5StWceZcGgP799Wmnc+cPWcVlF8a/zyPPPLbvmXA0cGBEoNtU2IuLs48MyKKNevimDf/I17+8QM0yiZV3c65zT+iV3Il+wovvTiuyvfw2mG+WHu006P8/e/zWLr0M1asWImbmxvjx4/jpZdeBMxrgcs+/4z33nuf0X8YDUCPHj3461/fBuDpp0dw5PBhJk6YCMDoP47G39/f6mLw5xeGlrqt9v34/9ixz5Obm8tHCz/m9u3b+Pv78+GHH2j35U6dNo2Z78xk1O//AJhHVosXf6I9T6OGR/H11wcZ+/xYYlevIjg4mJycHG7c/OlWoUmTJxEbG2uVtdu6dWtG/3G0zWXc3NyY/N+TWbN6Df/z+f8A5our7t27818/3tZlS5m0tDT8/f2s+ujll14mOjpaS8jq0qUL+kI9lm5rE9SGESNGsHPnTo4eOQqYp7CHDB1i6WDbngP25oLu7u5M/NNE1q1dp7XT18+XcePGAT9dHJRNUBs8ZDA/3PlBSz7z9vambdu25Jb5BLqXJ7zMypUrtfNwdnZm7Lix2tptVZ+rL738EjExMayKMd9h0LhxY16e8DINGjSo0uOJB0e538dr62c1FxbqrdZ8q5K9bGdnV6Of1Zyfn1+rQbes44kn+Ed0DPoKEnFcXMwBuqJ7fX8JyxrvyuXLaqScLfIL9VX+9KpNW7ZSVFREWGgH7Y0vOzub5JMpODs789wfR1XpU6vuJTc3F51Od8+PPbS3t7dKxLIoKCjAwcHhrmnV6lJKkZeXV+GbanFxMQaDAXd393KPLSkp0dpZ0eeZm0wmcnNz8fDwqPA1ZEuZkpIS9Ho9Hh4eFZ5PRWVmvjOTyMhI+vbre/c5FhVjZ2+n3fdanoKCApydna3Wyn+J4uJiHBwcrF77MStjKNQXMmnS3XkRRqMRg8GAi0vFgwWj0UhxcbGW7PVLmUwmjEZjuc9D8XD5RRGq7Mj3fmcv11XQBQjv1JGF8z4gfvcevks8QWZmFi4uLvj5+dCubRAD+/er9dF/VZOsfgmneo4UFdv+7USPPx5BWFgo+/bv58TJUySfNK99erfwZtCTA4js3btGP62qspHDvd5ca+pN1cLOzu6e7alfv36Fb7x2dnZW+yoKmA4ODpV+9rEtZZycnO4ZHCsqk5OTQ0lJiXb/7l3n6Fx5YKnpfi+vT8+fP2+VwVyWo6Njpe8VtpSpCgcHhxq70BC/beWOeKF2vze3Jke7D5vFn37O8aQTNpXt8UTXGruvuFBfVOVvKBIPppycHJKSkujTp8+v9nVsMpnYt28fjz76qHxClPjVqTDwWr66rzbY29vXeEazqF0mUykF+upnsAshhDCr8HK1tkalEnR/mxwc7HGxYQpRCCHEvd0zstZ08JWg+9tWz9FRgq8QQvxCFU41l2X57tzqrvlavvRegu6DwWQqpbikRNZ8hRCiGmwKvBaWNV9bD7EE2l9rAob4ZUoMBkoMxlrLBRBCiAdRlQKvheWQ8kbBZUe2MsJ9OBiNJowmE6WlpZhqMRteCCEeBNUKvEIIIYSoHpkDFkIIIeqQBF4hhBCiDkngFUIIIeqQY9r5S7/8UYQQQghhE0muEkIIIeqQTDULIYQQdUgCrxBCCFGHJPAKIYQQdUgCrxBCCFGHJPAKIYQQdUgCrxBCCFGHJPAKIYQQdUgCrxBCCFGHJPAKIYQQdUgCrxBCCFGHJPAKIYQQdUgCrxBCCFGHJPAKIYQQdUgCrxBCCFGHJPAKIYQQdajCwDtkyBC2bNnCnDlzePvtt+93O8V9Fh8fT58+fbhx4wbt27fn0qVL97tJQgjxm+RY0Y7MzEyKi4vJzc0lLy/vvjQuOjoaJycnnnvuOQAOHTrE0qVLtf3+/v5ERUXx+OOPA7B06VIOHTqk7W/RogXDhw/niSeesKm+iRMnkp+fD4C9vT1t27Zl+PDhdOjQATAHn9WrV2MymfD09OTjjz/GwcFBOz4vL4+YmBjWr19PXl4e/v7+jBw5kjFjxgBw8eJFVq5cycaNG/H09KRevXp88sknXLhwgbi4OABGjBjBs88+y5w5c0hNTQXgnXfeITg4mIMHD7JgwQLS0tLo3Lkzs2fPJiAggISEBD777DOtHS4uLgQHBzNp0iTc3Nwq7TeLN998kyeffJLIyMi7+qakpITLly9Tr149Tp8+jb29TJYIIUR1VPju2bx5cxo3boynpydNmjQpt4zRaLzngyulqt2w8+fP8+KLL9KtWzdtm7e3NykpKRiNRh577DHS09Pp2rUr69evByA0NJTDhw/j5OTEE088QXZ2Nt27d7d5dNarVy++/fZb7bG++uorQkNDuXLlCgCBgYGEhoaydu1alixZwp49e6yO//DDD1m1ahWzZs3igw8+YN++faSkpGh98fvf/56LFy8SHR3NyJEj2bt3L5cuXSIkJIS1a9cSHBxMaGio1hZPT0/OnDlD06ZNOXjwID179iQ8PFwLsh07duT69esEBATQvHlzDhw4wJAhQ/Dz8+OTTz5h2rRpNvWbRefOnRkzZky5f9dHHnkELy8vPDw8APD09Kz231YIIR5qqgIbNmxQ2dnZ6tixYyohIcFq3/bt21VYWJgClE6nUzNnzlQlJSVKKaVGjBihgoKC1JQpU5ROp1Ndu3ZVBw8eVEoplZSUpIKCglRQUJCaMWOG+uGHH1RISIgKCgpSYWFhqrCwUKtj+vTpqnv37ne1a9SoUerTTz/Vfp81a5bS6XSqoKBAKaVUZGSk2rBhg7Y/JCREzZ8/X9lq0KBBasWKFdrv3bt3V++//772+7p161Tfvn3V9OnT1ciRI62O1el0VnVv375dRUdHK6WUSk1NVYC6cuWKtv/DDz9Ux44dU0opFR4errZv367OnTunnnnmGaXX69WyZcvUK6+8opRSqmfPnlb1mUwm5ePjo2bMmKHVFRERoe1fsWKF0ul0NvebUkoVFRUpnU6n1q1bd1e/3Lp1S61atUoppdSCBQts7k8hhBDWqOoBhw8fVoBaunSpysnJUV9//bXS6XRq9uzZSimlMjIyFKBGjRqlTpw4oaZOnaoGDBiglFLKYDCohQsXKkDdvHlTKaXUnj17FKBSUlKs6tHpdGrJkiV31f/zAHLmzBkFqOPHjyulzIH3jTfeUP/+97/V7NmzFaC+/vprm8+vbOAtKSlRQUFB6t1339X2DxgwQK1atarcQDplyhQVFBSkPv74Y7Vr1y6l1+u1fSaTSQUFBakBAwaoFStWqCNHjqjS0lJt/5gxY9Snn36q5s2bpwC1fft2NWPGDLVkyRJlMBgUoAXxsvV17dpVKWUOvCEhISo9PV3t27dPDRgwQA0ePNjmfivbjrLHCSGEqFlVXqjbsGEDOp2Oa9eusWjRIuLj4wkICNDWKL28vACYO3cuYWFhTJ48mV27dgHg6OjIpEmT0Ol07Nu3D4CtW7cyadIk2rdvr9Vx48YN8vLyCAkJqbQ9fn5+AOTm5mrbTp48yf79+/n222/R6XScOHGiSuc4f/58+vXrh6enJ23atOH1118H4NKlS+zatQtHR0cuXryIl5cXsbGx2nFz585l2rRp7N27l/Hjx+Pl5cV//vMfwLxmvGfPHrp160ZsbCz9+/cnODhYmwYPDg7m/PnzbNu2jffee4+NGzdy8eJFAgICKCgoAMDX19eqnb6+vty+fVv7/fTp0wwbNozIyEgMBgOrVq2qUr8BdOrUqcr9JYQQwnaOVT2gqKiIJk2aEBgYqG177bXXCAgIsCrXqFEjAFxdXa22u7i48Ne//pWlS5cSGRnJ4sWLOXfunFWZnJwcABo2bFhpe3bv3g1A27ZttW3jx49n5MiRAKxevZoxY8YwceJEHB1tO91nnnmGZ599lnbt2lGvXj1t+5o1awgLC9PWdiMiIliyZAl//vOf0ev1rFixgilTpjB58mSUUrz77rvMnTuXQYMGkZKSQkZGBrNnzwZAr9czZMgQYmJimDlzJkFBQcTFxWE0GpkyZQr+/v74+vrSqlUrPDw88PLyYu/evfTv39/q3Nu1a6f9HhERwdGjR1m5ciXjx48nJyeHxo0b29xvAB4eHmRlZVX1aSGEEMJGVR7xDhw4kAsXLtCsWTOee+45nnrqKZydnTl8+DDwU0JVaWkpACaTyep/gAkTJrBv3z4mTJjA7373O9q0aWNVh2U0duvWrbvqLy0tRSlFYWEhx44d4/333+fll1+mWbNmABgMBoqLiyksLCQ1NZX4+HgCAwNtCrpGo5HS0lL8/PwIDg62Cromk4lly5Yxf/58li9fzvLly4mLi+POnTvs2bOHGzduMHXqVGJiYrTyN2/e1C4eEhMTGTp0KMnJyVo/Xbt2jQYNGgAQFBREcnIyQ4cOpVGjRvTq1YvTp0/j7+8PwBtvvME///lP4uPjKS4uZtWqVezatYtXXnkFMGcdW+odN24co0ePZvz48RgMBpv6zeLatWsEBQXV0tNNCCFEldd4lVLqb3/7mwK0fxEREWrz5s1KKaUiIiIUoEJCQpRSSnl5eSlA9ezZ0+ox3nrrLQWo7777rtw6AgMD1XvvvWe1bcOGDVb1BgYGqrfffltLEHrmmWes9gMqPDxcJSUlVXpOpaWlSqfTWR175MgRbf+gQYO07Tt37rQ6N0CdOnVK+9nHx0fpdDrVt29flZaWppQyr8Fa9gcFBSmdTqfGjBmjioqKlFJK5efnK0Dt379fKaVUbGysCgwM1Oo3GAxqxowZVu1bvnz5Xf1iSbC6deuWCgkJUYGBgZX2W1mDBw9Wzz33XA2uZgghhCjLTqnq3fNjNBq5du0aDRs2xN3dvcrHFxcXk5mZSevWrcvd//nnn7NkyRJSUlKws7P7+cUCSqlf3b2kiYmJtG/fXlv/tUy3W873woUL+Pj4kJmZSatWrahfv36V69Dr9WRnZ9OyZUubp85t7bfbt2/j6elJQkKCzfc+CyGEqJpqB97aVlRURJs2bVi9ejW9e/e+3815KHz00Ufs3r2bL7/88n43RQghHlhVTq6qK87OzuzevVtLtPql3nzzTS3DuDyvvfYa48aNu9+nfV+1bt36oe8DIYSobb/aEW9N0+v1WqJReZydnXFycrrfzRRCCPGAe2gCrxBCCPFr8OvKThJCCCEecBJ4hRBCiDokgVcIIYSoQxJ4hRBCiDokgVcIIYSoQxJ4hRBCiDokgVcIIYSoQxJ4hRBCiDokgVcIIYSoQxJ4hRBCiDokgVcIIYSoQxJ4hRBCiDokgVcIIYSoQxJ4hRBCiDokgVcIIYSoQxJ4hRBCiDokgVcIIYSoQxJ4hRBCiDr0/wFQibe0Dgu3qgAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAyMy0wOS0yM1QwNjo0NDoyOCswMDowMH5ON2UAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjMtMDktMjNUMDY6NDQ6MjgrMDA6MDAPE4/ZAAAAKHRFWHRkYXRlOnRpbWVzdGFtcAAyMDIzLTA5LTIzVDA2OjQ0OjI4KzAwOjAwWAauBgAAAABJRU5ErkJggg==" alt="图片"/></p><p>说明此时还没注入环境变量。下面使用命令行：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">DB_PASSWORD=123 ./hade app start</span></div></pre></div><p>启动服务。这个命令注入了DB_PASSWORD这个环境变量。<br/>重启打开浏览器看到输出。</p><p><img src="data:image/png;base64,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" alt="图片"/></p><p>环境变量注入成功！</p><p>这个时候我们不停止进程，直接修改配置文件database.yaml中的mysql.password：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">mysql:</span></div><div class="token-line"><span class="token plain">      hostname: 127.0.0.1</span></div><div class="token-line"><span class="token plain">      username: yejianfeng</span></div><div class="token-line"><span class="token plain">      password: 456789</span></div><div class="token-line"><span class="token plain">      timeout: 1</span></div><div class="token-line"><span class="token plain">      readtime: 2.3</span></div></pre></div><p>打开浏览器，输出已经变化了。</p><p><img src="data:image/png;base64,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" alt="图片"/></p><p>说明热更新已经生效了，测试成功。</p><p>今天所有代码的目录结构截图，也贴在这里供你对比检查，代码放在GitHub上的 <a target="_blank" rel="noopener noreferrer" href="https://github.com/gohade/coredemo/tree/geekbang/16">16分支<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 里。</p><p><img src="/blog-front/static/httpsstatic001geekbangorgresourceimage6c386c9b9046f41e4b5c0719fe205540c438.3fe215e2.png" alt="图片"/></p><h2 id="小结"><a aria-hidden="true" tabindex="-1" href="/blog-front/手把手带你写一个web框架/03.实战第2关框架核心/12#小结"><span class="icon icon-link"></span></a>小结</h2><p>配置服务在框架中是一个非常基础且重要的服务。</p><p>我们考虑了整个配置服务的实现，先读取配置文件，再替换环境变量，最后再根据路径获取配置项，这样三步走完成了基本的配置服务。在配置服务的基础上，我们又补充了配置服务加载时对App服务的更新，并且为配置服务增加了热更新的机制。</p><p>我个人认为，配置服务是一个App中最常用到的服务了，有非常方便的配置服务接口，能为业务代码节省不少的代码量。<strong>提供多种设置配置的方式，是真实从业务需求出发的</strong>。</p><p>比如在实际工作中，有的需求要求数据库密码不能进入git库，必须通过环境变量获取，我们就可以通过环境变量获取配置；而有的需求要求在一个服务器上调试测试和预发布环境，我们可以通过.env切换不同环境。所以，有个多层次的环境配置机制，对于一个框架来说是非常必要的。</p><h2 id="思考题"><a aria-hidden="true" tabindex="-1" href="/blog-front/手把手带你写一个web框架/03.实战第2关框架核心/12#思考题"><span class="icon icon-link"></span></a>思考题</h2><p>现在有配置文件服务了，但是根据路径、获取某个配置却只能在代码中获取。这里我们希望有一个命令行工具 <code>./hade config get &quot;database.mysql&quot;</code> 能获取到这个path路径对应的配置。你可以尝试实现么？</p><p>欢迎在留言区分享你的思考。感谢你的收听，如果觉得有收获，也欢迎把今天的内容分享给你身边的朋友，邀他一起学习。我们下节课见～</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/手把手带你写一个Web框架/03.实战第2关框架核心/12.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/23 20:50:41</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-front/umi.js"></script>
  </body>
</html>
